<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Conversacional Interna Version al 28-06-2025</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-track { background: #1e293b; }
        #chat-window::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .message-bubble { opacity: 0; transform: translateY(20px); animation: slide-up 0.4s ease-out forwards; }
        @keyframes slide-up { to { opacity: 1; transform: translateY(0); } }
        .typing-dot { width: 8px; height: 8px; background-color: #94a3b8; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .quick-starter-btn { background-color: transparent; border: 1px solid #475569; color: #94a3b8; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out; }
        .quick-starter-btn:hover { background-color: #1e293b; color: #e2e8f0; border-color: #64748b; }
        .suggestion-item {
            background-color: #334155; /* bg-slate-700 */
            border: 1px solid #475569; /* border-slate-600 */
            color: #e2e8f0; /* text-slate-200 */
            padding: 8px 12px;
            margin-top: 4px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            width: 100%;
            transition: background-color 0.2s;
        }
        .suggestion-item:hover {
            background-color: #475569; /* bg-slate-600 */
        }
        /* ESTILOS A√ëADIDOS PARA LOS BOTONES DEL FILTRO DE ADMIN */
        .admin-tab-btn {
            padding: 6px 12px;
            border-radius: 9999px; /* Para hacerlos pill-shaped */
            background-color: #334155; /* bg-slate-700 */
            color: #e2e8f0; /* text-slate-200 */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none; /* Asegura que no tengan borde por defecto */
        }
        .admin-tab-btn:hover {
            background-color: #475569; /* bg-slate-600 */
        }
        .admin-tab-btn.bg-yellow-500 { /* Clase para el bot√≥n activo */
            background-color: #f59e0b; /* bg-yellow-500 */
            color: #000; /* text-black */
            font-weight: bold;
        }

        /* Estilos para los botones de navegaci√≥n m√≥vil */
        .mobile-nav-btn {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            background-color: #334155; /* bg-slate-700 */
            border: 1px solid #475569; /* border-slate-600 */
            color: #94a3b8; /* text-slate-400 */
            transition: all 0.2s ease-in-out;
        }
        .mobile-nav-btn.active {
            background-color: #f59e0b; /* bg-amber-500 */
            color: #1e293b; /* text-slate-800 */
            border-color: #f59e0b;
        }

        .row-diff-positive { background-color: #f0fdf4; }
        .row-diff-negative { background-color: #fef2f2; }
        .row-diff-positive:hover { background-color: #dcfce7; }
        .row-diff-negative:hover { background-color: #fee2e2; }

/* ... otras reglas ... */


    </style>
</head>
<body class="bg-slate-900 text-slate-200 flex justify-center items-center min-h-screen">

<div id="login-card" class="w-full max-w-sm">
    <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl text-center">
        <h1 class="text-2xl mb-2 font-bold">Acceso a Plataforma</h1>
        <p class="text-slate-400 mb-6 text-sm">Ferreter√≠a Flores</p>
        <div class="mb-4">
            <input id="inputID" type="text" placeholder="Ingresa tu ID (ej. U001)"
                   class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-center" />
        </div>
        <div class="mb-4">
            <input id="inputPIN" type="password" placeholder="Ingresa tu PIN"
                   class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-center" />
        </div>
        <button id="btnLogin" class="w-full bg-emerald-500 hover:bg-emerald-600 px-6 py-2.5 rounded-lg text-white font-semibold transition duration-300 disabled:bg-slate-600">
            Entrar
        </button>
        <p id="loginMsg" class="mt-4 text-red-400 text-xs h-4"></p>
    </div>
</div>

<div id="app-container" class="w-full max-w-7xl h-[90vh] max-h-[900px] flex-col gap-4 hidden bg-slate-900 rounded-2xl shadow-2xl p-4">
    <header class="flex justify-between items-center flex-shrink-0">
        <div>
            <h1 id="header-title" class="text-lg font-bold text-white">Plataforma Conversacional Interna V280625</h1>
            <p id="header-subtitle" class="text-xs text-slate-400">Ferreter√≠a Flores</p>
        </div>
        <div class="flex items-center space-x-4">
            <div id="user-info-area" class="text-right">
                <p id="user-status" class="text-sm font-medium text-emerald-400">Conectando...</p>
                <p id="user-id-display" class="text-xs text-slate-400 font-mono"></p>
            </div>
            <div id="admin-view-switcher" class="flex items-center p-1 bg-slate-700 rounded-lg hidden">
                <button id="showChatBtn" class="px-3 py-1 rounded-md text-xs font-semibold">
                    Chat
                </button>
                <button id="showAdminPanelBtn" class="px-3 py-1 rounded-md text-xs font-semibold">
                    Panel
                </button>
            </div>
            <button id="logoutBtn" class="px-3 py-1 rounded text-xs text-slate-400 border border-slate-600 hover:text-red-400 hover:border-red-400 transition">
                Cerrar sesi√≥n
            </button>
        </div>
    </header>

    <div id="content-area" class="flex-1 w-full flex overflow-hidden">
        <div id="chat-column" class="flex flex-col h-full w-full bg-slate-800 rounded-xl overflow-hidden">
            <main id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-6" aria-live="polite">
                </main>
            <div id="quick-starters" class="p-4 border-t border-slate-700 flex-shrink-0">
                <p class="text-xs text-slate-400 mb-2 font-semibold">Iniciadores r√°pidos:</p>
                <div class="flex flex-wrap gap-2"></div>
            </div>
            <div id="suggestions-container" class="px-4 pb-2"></div>
            <footer class="p-4 border-t border-slate-700 flex-shrink-0">
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="text" id="message-input" placeholder="Escribe tu mensaje o reporte aqu√≠..." class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                    <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg p-2.5 transition disabled:bg-slate-600 flex items-center justify-center" aria-label="Enviar Mensaje">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
            </footer>
        </div>

        <div id="admin-panel" class="hidden flex-col h-full w-full bg-slate-800 rounded-xl overflow-y-auto">
             </div>
    </div>
</div>


    <div id="modal-container" class="fixed inset-0 bg-slate-900 bg-opacity-75 hidden justify-center items-center p-4 z-50">
    </div>

    <div id="custom-alert-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 hidden justify-center items-center p-4 z-[100]">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-white"></h3>
            <p id="custom-alert-message" class="text-slate-300 mb-6"></p>
            <button id="custom-alert-close-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg">
                Aceptar
            </button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 hidden justify-center items-center p-4 z-[100]">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h3 id="custom-confirm-title" class="text-xl font-bold mb-4 text-white">Confirmaci√≥n</h3>
            <p id="custom-confirm-message" class="text-slate-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="custom-confirm-yes-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">
                    S√≠
                </button>
                <button id="custom-confirm-no-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg">
                    No
                </button>
            </div>
        </div>
    </div>
<script>
    // =========================================================================
    // ================ SCRIPT FINAL Y UNIFICADO PARA INDEX.HTML ===============
    // =========================================================================

    // --- Frontend Elements ---
// --- Frontend Elements (NUEVA ESTRUCTURA) ---
const loginCard = document.getElementById('login-card');
const appContainer = document.getElementById('app-container'); // Contenedor principal
const btnLogin = document.getElementById('btnLogin');
const inputID = document.getElementById('inputID');
const loginMsg = document.getElementById('loginMsg');

// Elementos de la cabecera
const userStatus = document.getElementById('user-status');
const userIdDisplay = document.getElementById('user-id-display');
const logoutBtn = document.getElementById('logoutBtn');
const adminViewSwitcher = document.getElementById('admin-view-switcher');
const showChatBtn = document.getElementById('showChatBtn');
const showAdminPanelBtn = document.getElementById('showAdminPanelBtn');

// Paneles de contenido
const chatColumn = document.getElementById('chat-column');
const adminPanel = document.getElementById('admin-panel');

// Elementos del chat (la mayor√≠a se mantienen)
const chatWindow = document.getElementById('chat-window');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const quickStartersContainer = document.getElementById('quick-starters').querySelector('div');
const suggestionsContainer = document.getElementById('suggestions-container');

    // --- Global State Variables ---
    let perfilActual = null;
    let currentModalEnteredCounts = {};
    let adminState = { // New admin state
        items: [],
        filters: {
            tipo: 'Todos',
            fecha: ''
        }
    };

    // --- Custom Alert/Confirm Functions ---
    function showCustomAlert(message, type = 'info', onClose) {
        const alertModal = document.getElementById('custom-alert-modal');
        const alertMessage = document.getElementById('custom-alert-message');
        const alertTitle = document.getElementById('custom-alert-title');
        const alertCloseBtn = document.getElementById('custom-alert-close-btn');

        alertMessage.textContent = message;
        alertModal.classList.remove('hidden', 'bg-red-900/75', 'bg-emerald-900/75', 'bg-blue-900/75', 'bg-slate-900/75');
        alertModal.classList.add('flex');

        let title = '';
        switch (type) {
            case 'success':
                alertModal.classList.add('bg-emerald-900/75');
                title = '√âxito';
                break;
            case 'error':
                alertModal.classList.add('bg-red-900/75');
                title = 'Error';
                break;
            default: // info
                alertModal.classList.add('bg-slate-900/75');
                title = 'Informaci√≥n';
                break;
        }
        alertTitle.textContent = title;

        alertCloseBtn.onclick = () => {
            alertModal.classList.add('hidden');
            if (typeof onClose === 'function') onClose();
        };
    }

    function showCustomConfirm(message, yesText = 'S√≠', noText = 'No', title = 'Confirmaci√≥n') {
        return new Promise((resolve) => {
            const confirmModal = document.getElementById('custom-confirm-modal');
            const confirmMessage = document.getElementById('custom-confirm-message');
            const confirmTitle = document.getElementById('custom-confirm-title');
            const confirmYesBtn = document.getElementById('custom-confirm-yes-btn');
            const confirmNoBtn = document.getElementById('custom-confirm-no-btn');

            confirmMessage.innerHTML = message;
            if (confirmTitle) confirmTitle.textContent = title;
            confirmYesBtn.textContent = yesText;
            confirmNoBtn.textContent = noText;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');

            const closeConfirm = (result) => {
                confirmModal.classList.add('hidden');
                resolve(result);
            };

            confirmYesBtn.onclick = () => closeConfirm(true);
            confirmNoBtn.onclick = () => closeConfirm(false);
        });
    }

    // --- LOGOUT BUTTON ---
    logoutBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm("¬øSeguro que quer√©s cerrar sesi√≥n?");
        if (!confirmed) return;
        sessionStorage.clear();
        location.reload();
    });

    // --- L√ìGICA DE LOGIN E INICIALIZACI√ìN (Modificado y unificado) ---

    // Este listener document.addEventListener('DOMContentLoaded') ahora gestiona el auto-login
    document.addEventListener('DOMContentLoaded', () => {
        const storedProfile = sessionStorage.getItem('perfil');
        if (storedProfile) {
            // Si hay un perfil guardado, rellena el ID y simula un clic en el bot√≥n de login
            inputID.value = JSON.parse(storedProfile).UsuarioID;
            // No llamar directamente a procesarDatosIniciales aqu√≠
            // para que pase por el flujo normal de validaci√≥n del login.
            btnLogin.click();
        } else {
            console.log("No hay sesi√≥n almacenada, mostrando pantalla de login.");
        }
    });

    // Listener para el bot√≥n de login
// Dentro de tu etiqueta <script> en index.html

btnLogin.addEventListener('click', () => {
    const id = document.getElementById('inputID').value.trim();
    const pin = document.getElementById('inputPIN').value.trim();

    if (!id || !pin) {
        // En lugar de usar loginMsg, usamos el modal de alerta que ya tienes
        showCustomAlert("Por favor, ingresa tu ID y tu PIN.", 'info');
        return;
    }

    loginMsg.textContent = "Validando...";
    btnLogin.disabled = true;

    // La funci√≥n que llama al backend ahora debe enviar ambos argumentos
    google.script.run
        .withSuccessHandler(procesarDatosIniciales)
        // Asumo que tienes una funci√≥n para mostrar errores, si no, puedes usar showCustomAlert
        .withFailureHandler(err => {
            showCustomAlert(`Error de Login: ${err.message}`, 'error');
            btnLogin.disabled = false;
            loginMsg.textContent = '';
        })
        .cargarDatosIniciales(id, pin);
});


    // Funci√≥n principal que procesa los datos iniciales despu√©s del login exitoso
    // MODIFICACI√ìN DE LA FUNCI√ìN procesarDatosIniciales
function procesarDatosIniciales(datos) {
    console.log("üì¶ datos recibidos del Apps Script:", datos);
    if (!datos.ok) {
        loginMsg.textContent = datos.msg;
        btnLogin.disabled = false;
        return;
    }

    // Guardar estado
    sessionStorage.setItem('perfil', JSON.stringify(datos.perfil));
    sessionStorage.setItem('sessionId', datos.sesionId);
    perfilActual = datos.perfil;

    // --- NUEVA L√ìGICA DE UI ---
    loginCard.classList.add('hidden');
    appContainer.classList.remove('hidden');
    appContainer.classList.add('flex'); // Aseguramos que sea flex

    // Renderizar Header
    userStatus.textContent = `Activo: ${perfilActual.Nombre}`;
    userIdDisplay.textContent = `Sucursal: ${perfilActual.Sucursal} | Rol: ${perfilActual.Rol}`;

    // Renderizar Chat
    renderizarChatInicial(datos.mensajeAnuncio, datos.quickStarters);

    // --- L√ìGICA DE VISIBILIDAD PARA ADMIN ---
    if (perfilActual.Rol === "Administrador") {
        adminViewSwitcher.classList.remove('hidden');
        showChatBtn.addEventListener('click', () => updateActiveView('chat'));
        showAdminPanelBtn.addEventListener('click', () => updateActiveView('admin'));
        updateActiveView('chat'); // Vista inicial por defecto

        // Inicializar el contenido del panel de admin (tu funci√≥n original)
        renderAdminPanel();
        refrescarPanelAdmin();

    } else {
        adminViewSwitcher.classList.add('hidden');
        updateActiveView('chat'); // Los no-admin solo ven el chat
        adminPanel.remove(); // Opcional: eliminar el panel si no es admin
    }

    // Habilitar inputs del chat
    messageInput.disabled = false;
    messageInput.focus();
    sendButton.disabled = false;
}

    // --- L√ìGICA DE CHAT: Funciones para renderizar mensajes y manejar la IA ---

    // Esta funci√≥n reemplaza a 'initializeChat' y se encarga de mostrar la info del usuario
    function renderizarHeader(perfil) {
        const userStatus = document.getElementById('user-status');
        const userIdDisplay = document.getElementById('user-id-display');

        userStatus.textContent = `Activo: ${perfil.Nombre}`;
        userIdDisplay.textContent = `Sucursal: ${perfil.Sucursal} | Rol: ${perfil.Rol}`;
    }

    // Esta funci√≥n reemplaza la l√≥gica de bienvenida y quick starters que estaba en 'procesarDatosIniciales'
    function renderizarChatInicial(mensajeAnuncio, quickStarters) {
        if (mensajeAnuncio && Array.isArray(mensajeAnuncio)) {
            let delay = 500;
            mensajeAnuncio.forEach(mensaje => {
                setTimeout(() => {
                    addMessage(mensaje, 'system');
                }, delay);
                delay += 1200;
            });
        }
        if (quickStarters && Array.isArray(quickStarters)) {
            renderQuickStarters(quickStarters);
        }
    }

    function addMessage(text, sender) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `flex message-bubble ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

        let bubbleClasses = 'max-w-md lg:max-w-xl rounded-2xl px-4 py-2.5 text-sm shadow-md ';
        let bubbleContent = '';

        switch (sender) {
            case 'user':
                bubbleClasses += 'bg-blue-600 text-white rounded-br-lg';
                bubbleContent = `<p>${text}</p>`;
                break;
            case 'ai':
                bubbleClasses += 'bg-slate-700 text-slate-200 rounded-bl-lg';
                bubbleContent = `<p>${text}</p>`;
                break;
            case 'system':
                bubbleClasses += 'bg-yellow-900/50 border border-yellow-600/50 text-yellow-300 w-full rounded-lg';
                bubbleContent = `<div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><p class="font-mono text-xs">${text}</p></div>`;
                break;
        }

        messageContainer.innerHTML = `<div class="${bubbleClasses}">${bubbleContent}</div>`;
        chatWindow.appendChild(messageContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showTypingIndicator() {
        if (document.getElementById('typing-indicator')) return;
        const typingIndicator = document.createElement('div');
        typingIndicator.id = 'typing-indicator';
        typingIndicator.className = 'flex justify-start message-bubble';
        typingIndicator.innerHTML = `<div class="bg-slate-700 text-slate-200 rounded-2xl rounded-bl-lg px-4 py-2.5 shadow-md"><div class="flex items-center gap-1.5"><span class="typing-dot"></span><span class="typing-dot" style="animation-delay: 0.2s;"></span><span class="typing-dot" style="animation-delay: 0.4s;"></span></div></div>`;
        chatWindow.appendChild(typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    function getAIResponse(payload) {
        messageInput.disabled = true;
        sendButton.disabled = true;
        showTypingIndicator();

        const userIdToPass = perfilActual?.UsuarioID;
        const sessionIdToPass = sessionStorage.getItem('sessionId');

        if (!userIdToPass || !sessionIdToPass) {
            hideTypingIndicator();
            showCustomAlert("‚ö†Ô∏è La sesi√≥n de usuario no est√° activa o se ha perdido. Por favor, intent√° cerrar sesi√≥n y volver a entrar.", 'error');
            messageInput.disabled = false;
            sendButton.disabled = false;
            return;
        }

        google.script.run
            .withSuccessHandler(handleAIResponse)
            .withFailureHandler(handleAIError)
            .enviarAOpenAI(sessionIdToPass, userIdToPass, payload);
    }

    function handleAIResponse(data) {
        hideTypingIndicator();

        if (data.content) {
            addMessage(data.content, 'ai');
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }

        // --- NEW LOGIC TO HANDLE TOOLS ---
        if (data.tool_call) {
            const toolCall = data.tool_call;
            const functionName = toolCall.function.name;
            const functionArgs = JSON.parse(toolCall.function.arguments);

            addMessage(`Ejecutando: ${functionName}...`, 'system');

            const userId = perfilActual.UsuarioID;
            const sessionId = sessionStorage.getItem('sessionId');

            google.script.run
                .withSuccessHandler(functionResult => {
                    addMessage(`Resultado: ${functionResult}`, 'system');

                    const payloadForNextStep = {
                        texto: null,
                        tool_response: {
                            tool_call_id: toolCall.id,
                            function_name: functionName,
                            result: functionResult
                        }
                    };

                    showTypingIndicator();
                    google.script.run
                        .withSuccessHandler(handleAIResponse)
                        .withFailureHandler(handleAIError)
                        .enviarAOpenAI(sessionId, userId, payloadForNextStep);
                })
                .withFailureHandler(handleAIError)
                .ejecutarHerramienta(functionName, functionArgs, userId, sessionId);
        } else {
            // If it's not a function call, make sure inputs are enabled
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }
    }

    function handleAIError(error) {
        hideTypingIndicator();
        showCustomAlert(`Ocurri√≥ un error al procesar tu solicitud: ${error.message}.`, 'error');
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    }

    // --- L√≥gica del Panel de Administraci√≥n (NUEVAS FUNCIONES) ---

    function renderAdminPanel() {
        const container = document.getElementById('admin-panel');
        if (!container) return;

        // 1. Dibuja la estructura y los filtros
        container.innerHTML = `
            <div class="p-4 sticky top-0 bg-slate-800 border-b border-slate-700 z-10">
                <h2 class="text-lg font-bold text-white mb-4">Panel de Administraci√≥n</h2>
                <div id="admin-filter-tabs" class="flex gap-2 flex-wrap text-sm mb-3">
                  <button data-tipo="Todos" class="admin-tab-btn bg-yellow-500 text-black font-bold">Todos</button>
                  <button data-tipo="Problema" class="admin-tab-btn">‚ö†Ô∏è Problemas</button>
                  <button data-tipo="Sugerencia" class="admin-tab-btn">üí° Sugerencias</button>
                  <button data-tipo="Tarea" class="admin-tab-btn">üìù Tareas</button>
                  <button data-tipo="Caja" class="admin-tab-btn">üí∞ Caja</button>
                </div>
                <input type="date" id="admin-filter-fecha" class="w-full bg-slate-700 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-3">
                 <button onclick="google.script.run.withSuccessHandler(resumen => showCustomAlert(resumen, 'info')).withFailureHandler(error => showCustomAlert('Error al cargar resumen: ' + error.message, 'error')).generarResumenAdmin();" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg px-4 py-1.5 text-sm">
                    Generar Resumen Diario
                </button>
            </div>
            <div id="admin-items-container" class="p-4 space-y-3"></div>
        `;

        // Set initial filter values if they exist in adminState
        const initialActiveButton = document.querySelector(`.admin-tab-btn[data-tipo="${adminState.filters.tipo}"]`);
        if (initialActiveButton) {
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('bg-yellow-500', 'text-black', 'font-bold'));
            initialActiveButton.classList.add('bg-yellow-500', 'text-black', 'font-bold');
        }
        document.getElementById('admin-filter-fecha').value = adminState.filters.fecha;

        renderFilteredAdminItems(); // Renderiza los √≠tems inicialmente

        // Listener para los nuevos botones de tipo (usando addEventListener)
        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                adminState.filters.tipo = btn.dataset.tipo;
                document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('bg-yellow-500', 'text-black', 'font-bold'));
                btn.classList.add('bg-yellow-500', 'text-black', 'font-bold');
                renderFilteredAdminItems();
            });
        });

        // Listener para el input de fecha (usando addEventListener)
        document.getElementById('admin-filter-fecha').addEventListener('change', (e) => {
            adminState.filters.fecha = e.target.value;
            renderFilteredAdminItems();
        });
    }

    function renderFilteredAdminItems() {
        const container = document.getElementById('admin-items-container');
        if (!container) return;

        let itemsToShow = [...adminState.items];

        if (adminState.filters.tipo !== 'Todos') {
            itemsToShow = itemsToShow.filter(item => item.tipo === adminState.filters.tipo);
        }

        if (adminState.filters.fecha) {
            itemsToShow = itemsToShow.filter(item => {
                const itemDate = item.fecha instanceof Date && !isNaN(item.fecha) ? item.fecha :
                                 (typeof item.fecha === 'string' ? new Date(item.fecha) : null);

                if (itemDate && !isNaN(itemDate.getTime())) {
                    const filterDate = new Date(adminState.filters.fecha);
                    return itemDate.getFullYear() === filterDate.getFullYear() &&
                           itemDate.getMonth() === filterDate.getMonth() &&
                           itemDate.getDate() === filterDate.getDate();
                }
                return false;
            });
        }

        if (itemsToShow.length === 0) {
            container.innerHTML = '<p class="text-slate-400 text-center text-sm p-4">No hay √≠tems que coincidan.</p>';
            return;
        }

        // 1. Creamos el HTML como antes
        container.innerHTML = itemsToShow.map(item => {
            const statusColor = item.estado === 'Pendiente' ? 'bg-yellow-500/20 text-yellow-300' : 'bg-green-500/20 text-green-300';
            const tipoIcono = { Problema: '‚ö†Ô∏è', Sugerencia: 'üí°', Tarea: 'üìù', Caja: 'üí∞' }[item.tipo] || 'üìÅ';
            const fechaFormateada = item.fecha && item.fecha instanceof Date && !isNaN(item.fecha.getTime()) ?
                                     item.fecha.toLocaleDateString('es-NI') : 'Sin fecha';

            return `
                <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-white text-sm pr-2">${tipoIcono} ${item.asunto || 'Sin asunto'}</p>
                        <span class="text-xs ${statusColor} px-2 py-0.5 rounded-full whitespace-nowrap">${item.estado}</span>
                    </div>
                    <p class="text-xs text-slate-400 mt-1 mb-2 break-words">${item.detalle || ''}</p>
                    <div class="flex justify-between items-center text-xs text-slate-500">
                        <span>${item.usuario || 'N/A'} - ${fechaFormateada}</span>
                        ${item.estado === 'Pendiente' ?
                            `<button data-item-id="${item.id}" class="btn-marcar-revisado px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs">Marcar Revisado</button>` : ''
                        }
                    </div>
                </div>
            `;
        }).join('');

        // --- 2. A√ëADIMOS LOS LISTENERS DESPU√âS DE CREAR EL HTML ---
        container.querySelectorAll('.btn-marcar-revisado').forEach(btn => {
            btn.addEventListener('click', () => {
                const itemId = btn.dataset.itemId;
                solicitarCambioEstado(itemId, 'Revisado');
            });
        });
    }

    function solicitarCambioEstado(itemId, nuevoEstado) {
        if (!confirm(`¬øSeguro que quieres cambiar el estado a "${nuevoEstado}"?`)) return;

        google.script.run
            .withSuccessHandler(response => {
                showCustomAlert(response, 'success');
                // Para refrescar la lista, simplemente llamamos a nuestra nueva funci√≥n central.
                refrescarPanelAdmin(); // <-- Llamada a la nueva funci√≥n de refresco
            })
            .withFailureHandler(err => showCustomAlert(err.message, 'error'))
            .actualizarEstadoItemAdmin(itemId, nuevoEstado);
    }

    // --- CHAT EVENTS ---
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const userInput = messageInput.value.trim();
        if (userInput) {
            addMessage(userInput, 'user');
            getAIResponse({ texto: userInput, claveProducto: null });
            messageInput.value = '';
        }
    });





quickStartersContainer.addEventListener('click', (e) => {
    // Nos aseguramos de que el clic fue en un bot√≥n de inicio r√°pido
    if (e.target.tagName === 'BUTTON' && e.target.classList.contains('quick-starter-btn')) {
        
        // Obtenemos el nombre de la funci√≥n que guardamos en el atributo 'data-function-name' del bot√≥n
        const functionName = e.target.dataset.functionName;
        const buttonText = e.target.textContent;

        // ==========================================================
        // ==== ¬°NUEVA L√ìGICA INTELIGENTE! ====
        // ==========================================================
        
        // Comprobamos si el bot√≥n presionado es el de registrar conteo
        if (functionName === 'registrarConteo') {
            
            // Si es el de conteo, llamamos directamente a la funci√≥n que abre el modal
            console.log("Bot√≥n de conteo detectado. Abriendo modal directamente.");
            gestionarAperturaModal(); // Asumo que esta es tu funci√≥n para el modal de conteo
            
        } else {
            
            // Si es cualquier otro bot√≥n, mantenemos el comportamiento original:
            // Lo enviamos como un mensaje al chat para que la IA lo procese.
            console.log(`Bot√≥n regular detectado: "${buttonText}". Enviando al chat.`);
            addMessage(buttonText, 'user');
            getAIResponse({ texto: buttonText });
            messageInput.value = '';
            messageInput.focus();
        }
    }
});



function renderQuickStarters(starters) {
    quickStartersContainer.innerHTML = '';
    if (!starters || starters.length === 0) return;

    const buttonClasses = 'quick-starter-btn bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-full text-sm transition duration-200 ease-in-out';

    starters.forEach(starterObject => {
        const button = document.createElement('button');
        button.className = buttonClasses;
        button.textContent = starterObject.NombrePantalla;
        button.dataset.functionName = starterObject.NombreFuncion;
        quickStartersContainer.appendChild(button);
    });
}

    // --- L√ìGICA DEL BUSCADOR @ ---
    messageInput.addEventListener('input', () => {
        const text = messageInput.value;
        const atIndex = text.lastIndexOf('@');

        if (atIndex !== -1) {
            const query = text.substring(atIndex + 1);
            if (query.length >= 2) {
                google.script.run
                    .withSuccessHandler(displaySuggestions)
                    .buscarArticulo(query);
            } else {
                suggestionsContainer.innerHTML = '';
            }
        } else {
            suggestionsContainer.innerHTML = '';
        }
    });

    function displaySuggestions(suggestions) {
        suggestionsContainer.innerHTML = '';
        if (suggestions && suggestions.length > 0) {
            suggestions.forEach(suggestion => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'suggestion-item';
                item.textContent = suggestion;
                item.onclick = () => {
                    selectSuggestion(suggestion);
                };
                suggestionsContainer.appendChild(item);
            });
        }
    }

    function selectSuggestion(suggestion) {
        const text = messageInput.value;
        const atIndex = text.lastIndexOf('@');
        const newText = text.substring(0, atIndex) + suggestion + ' ';
        messageInput.value = newText;
        suggestionsContainer.innerHTML = '';
        messageInput.focus();
    }

    // --- L√ìGICA DEL MODAL (Conteo de Inventario) ---

    function actualizarConteoEnMemoria(inputElement, claveProducto) {
        const row = inputElement.closest('tr');
        if (!row) return;

        if (!currentModalEnteredCounts[claveProducto]) {
            currentModalEnteredCounts[claveProducto] = {};
        }

        const tipo = inputElement.dataset.type;
        if (tipo) {
            currentModalEnteredCounts[claveProducto][tipo] = inputElement.value.trim();
        }

        const registro = currentModalEnteredCounts[claveProducto];
        if (!registro.fisico && !registro.cpi && !registro.vpe && !registro.razon) {
            delete currentModalEnteredCounts[claveProducto];
        }

        const sistema = parseFloat(row.querySelector('input[data-type="sistema"]').value) || 0;
        const fisico = parseFloat(row.querySelector('input[data-type="fisico"]').value) || 0;
        const cpi = parseFloat(row.querySelector('input[data-type="cpi"]').value) || 0;
        const vpe = parseFloat(row.querySelector('input[data-type="vpe"]').value) || 0;
        const diferencia = fisico - sistema - vpe - cpi;

        const diffCell = row.querySelector('[data-type="diferencia"]');
        if (diffCell) diffCell.textContent = isNaN(diferencia) ? '' : diferencia;

        row.classList.remove('row-diff-positive', 'row-diff-negative');
        if (diferencia > 0) row.classList.add('row-diff-positive');
        else if (diferencia < 0) row.classList.add('row-diff-negative');
    }

    function gestionarAperturaModal() {
        console.log("Solicitando HTML del modal de conteo al servidor...");
        google.script.run
            .withSuccessHandler(construirModal)
            .withFailureHandler(error => {
                showCustomAlert("Error al cargar el modal: " + error.message, 'error');
            })
            .abrirModalDeConteo();
    }

    function construirModal(contenidoHTML) {
    if (!contenidoHTML) {
        showCustomAlert("Error: El contenido del modal est√° vac√≠o.", 'error');
        return;
    }

    const modalContainer = document.getElementById("modal-container");
    modalContainer.innerHTML = contenidoHTML;

    // ---> MEJORA 1: AbortController para limpiar eventos.
    const controller = new AbortController();
    const { signal } = controller;

    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('results-table-body');
    const submitBtn = document.getElementById('submitBtn');
    const btnCerrar = document.getElementById("mi-boton-de-cerrar");
    const filterSelect = document.getElementById('conteoFilter');

    let currentModalFilter = filterSelect ? filterSelect.value : 'Todos';

    let inventarioCompletoDelModal = [];
    currentModalEnteredCounts = {};

    modalContainer.classList.remove('hidden');
    modalContainer.classList.add('flex');

    // Funci√≥n para cerrar y limpiar todo
    function cerrarYLimpiarModal(submitted = false) {
        modalContainer.classList.add('hidden');
        modalContainer.classList.remove('flex');
        modalContainer.innerHTML = ''; // Limpiar el contenido para la pr√≥xima vez
        
        // ---> MEJORA 1: Se abortan todos los listeners asociados a este modal.
        controller.abort();
        
        // Si el modal se cerr√≥ despu√©s de un env√≠o exitoso, no se hace nada m√°s
        if (submitted) return;
        
        // L√≥gica adicional si se cancela, por ejemplo, un mensaje de confirmaci√≥n
        // const unsavedChanges = Object.keys(currentModalEnteredCounts).length > 0;
        // if (unsavedChanges && !confirm("¬øSeguro que quieres cerrar? Perder√°s los conteos no guardados.")) {
        //     modalContainer.classList.remove('hidden');
        //     modalContainer.classList.add('flex');
        //     return; // No cerrar si el usuario cancela
        // }
    }

    function tocaConteoHoy(producto) {
        const periodo = (producto.Periodo || '').toLowerCase();
        const diaAsignado = parseInt(producto.Dia, 10);
        const hoy = new Date();

        if (periodo === 'diario') return true;

        const diaSemanaActual = ((hoy.getDay() + 6) % 7) + 1; // Lunes=1, Domingo=7

        if (periodo === 'semanal') {
            return diaSemanaActual === diaAsignado;
        }

        const esLaborable = date => {
            const d = date.getDay();
            return d !== 0 && d !== 6;
        };

        if (periodo === 'mensual') {
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            let contador = 0;
            for (let d = new Date(inicioMes); d <= hoy; d.setDate(d.getDate() + 1)) {
                if (esLaborable(d)) contador++;
            }
            return contador === diaAsignado;
        }

        if (periodo === 'bimestral') {
            const inicioAnio = new Date(hoy.getFullYear(), 0, 1);
            let contador = 0;
            for (let d = new Date(inicioAnio); d <= hoy; d.setDate(d.getDate() + 1)) {
                if (esLaborable(d)) contador++;
            }
            const diaCiclo = ((contador - 1) % 44) + 1;
            return diaCiclo === diaAsignado;
        }

        return false;
    }

    function renderizarTabla(articulos) {
        if (!tableBody) return;

        const headRow = tableBody.closest('table').querySelector('thead tr');
        if (headRow && !headRow.dataset.extendido) {
            headRow.innerHTML = `
                <th class="p-3 text-center w-4"><input type="checkbox" id="select-all"></th>
                <th class="p-3">Producto</th>
                <th class="p-3 w-32">Sistema</th>
                <th class="p-3 w-32">F√≠sico</th>
                <th class="p-3 w-24">CPI</th>
                <th class="p-3 w-24">VPE</th>
                <th class="p-3">Raz√≥n</th>
                <th class="p-3 w-24">Diferencia</th>
                <th class="p-3 w-16">Acciones</th>`;
            headRow.dataset.extendido = '1';
        }

        let htmlFilas = '';
        articulos.forEach((articulo) => {
            const guardado = currentModalEnteredCounts[articulo.Clave] || {};
            const valFisico = guardado.fisico || '';
            const valCpi = guardado.cpi || '';
            const valVpe = guardado.vpe || '';
            const valRazon = guardado.razon || '';

            const sistemaNum = parseFloat(articulo.StockSistema || 0);
            const fisicoNum = parseFloat(valFisico) || 0;
            const cpiNum = parseFloat(valCpi) || 0;
            const vpeNum = parseFloat(valVpe) || 0;
            const diferencia = fisicoNum - sistemaNum - vpeNum - cpiNum;

            const rowClass = diferencia > 0 ? 'row-diff-positive' : (diferencia < 0 ? 'row-diff-negative' : '');

            const opciones = [
                { v: '', t: 'Seleccionar...' },
                { v: 'Entrega incorrecta', t: 'Entrega incorrecta' },
                { v: 'Recepci√≥n incorrecta', t: 'Recepci√≥n incorrecta' },
                { v: 'Devoluci√≥n de cliente', t: 'Devoluci√≥n de cliente' },
                { v: 'Devoluci√≥n de proveedor', t: 'Devoluci√≥n de proveedor' }
            ];
            const opcionesHtml = opciones.map(o => `<option value="${o.v}" ${valRazon === o.v ? 'selected' : ''}>${o.t}</option>`).join('');

            htmlFilas += `
                <tr data-clave="${articulo.Clave}" class="border-b border-slate-700 hover:bg-slate-800 ${rowClass}">
                    <td class="p-2 text-center"><input type="checkbox" class="fila-checkbox"></td>
                    <td class="p-3">
                        <div class="font-bold">${articulo.Descripcion}</div>
                        <div class="text-xs text-slate-400">${articulo.Clave}</div>
                    </td>
                    <td class="p-2 align-middle">
                        <input type="number" data-type="sistema" readonly class="w-full p-2 rounded bg-slate-700/50 text-white border-none" value="${articulo.StockSistema || 0}">
                    </td>
                    <td class="p-2 align-middle">
                        <input type="number" data-type="fisico" class="w-full p-2 rounded bg-slate-700 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Contado" value="${valFisico}" oninput="actualizarConteoEnMemoria(this, '${articulo.Clave}')">
                    </td>
                    <td class="p-2 align-middle">
                        <input type="number" data-type="cpi" class="w-full p-2 rounded bg-slate-700 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="0" value="${valCpi}" oninput="actualizarConteoEnMemoria(this, '${articulo.Clave}')">
                    </td>
                    <td class="p-2 align-middle">
                        <input type="number" data-type="vpe" class="w-full p-2 rounded bg-slate-700 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="0" value="${valVpe}" oninput="actualizarConteoEnMemoria(this, '${articulo.Clave}')">
                    </td>
                    <td class="p-2 align-middle">
                        <select data-type="razon" class="w-full p-2 rounded bg-slate-700 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" onchange="actualizarConteoEnMemoria(this, '${articulo.Clave}')">
                            ${opcionesHtml}
                        </select>
                    </td>
                    <td class="p-2 align-middle" data-type="diferencia">${isNaN(diferencia) ? '' : diferencia}</td>
                    <td class="p-2 text-center">
                        <button type="button" class="reset-row-btn text-red-400 hover:text-red-600" data-clave="${articulo.Clave}">‚Ü∫</button>
                    </td>
                </tr>`;
        });
        tableBody.innerHTML = htmlFilas || '<tr><td colspan="9" class="text-center p-4">No se encontraron art√≠culos.</td></tr>';
    }

    function buscarArticulosLocalmente() {
        let lista = [...inventarioCompletoDelModal];

        if (currentModalFilter === 'hoy') {
            lista = lista.filter(tocaConteoHoy);
        }

        const terminos = searchInput.value.toLowerCase().split(' ').filter(Boolean);
        if (terminos.length > 0) {
            lista = lista.filter(item => {
                const searchableText = `${item.Descripcion} ${item.Clave}`.toLowerCase();
                return terminos.every(t => searchableText.includes(t));
            });
        }

        if (currentModalFilter === 'hoy') {
            lista = lista.slice(0, 40);
        }

        renderizarTabla(lista);
    }
    
    // ---> MEJORA 2: Funci√≥n de "Debounce"
    function debounce(func, timeout = 300){
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
      };
    }
    
    // Se crea una versi√≥n "debounced" de la b√∫squeda
    const debouncedSearch = debounce(buscarArticulosLocalmente);


    // ---> MEJORA 3: Mostrar estado de carga inicial
    tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-4">Cargando inventario...</td></tr>';
    searchInput.disabled = true;
    submitBtn.disabled = true;

    google.script.run
        .withSuccessHandler(articulos => {
            inventarioCompletoDelModal = articulos;
            buscarArticulosLocalmente();
            // ---> MEJORA 3: Habilitar controles cuando los datos llegan
            searchInput.disabled = false;
            submitBtn.disabled = false;
            searchInput.focus(); // Poner el foco en el buscador
        })
        .withFailureHandler(err => {
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-red-400">Error al cargar inventario: ${err.message}</td></tr>`;
            // El bot√≥n de submit sigue deshabilitado, pero el de cerrar no.
        })
        .buscarArticulosAvanzado('');

    // ---> MEJORA 2: El evento ahora es 'input' y usa la versi√≥n debounced
    searchInput.addEventListener('input', debouncedSearch, { signal });

    if (filterSelect) {
        filterSelect.addEventListener('change', () => {
            currentModalFilter = filterSelect.value;
            buscarArticulosLocalmente();
        }, { signal });
    }

    const selectAllCb = modalContainer.querySelector('#select-all');
    const batchContainer = modalContainer.querySelector('#batch-actions');
    const batchSelect = modalContainer.querySelector('#batch-razon');
    const applyBatchBtn = modalContainer.querySelector('#applyBatchBtn');

    function actualizarVisibilidadLote() {
        const count = tableBody.querySelectorAll('.fila-checkbox:checked').length;
        if (batchContainer) batchContainer.classList.toggle('hidden', count === 0);
    }

    tableBody.addEventListener('change', (e) => {
        if (e.target.classList.contains('fila-checkbox')) {
            actualizarVisibilidadLote();
        }
    }, { signal });

    tableBody.addEventListener('click', (e) => {
        const btn = e.target.closest('.reset-row-btn');
        if (btn) {
            const clave = btn.dataset.clave;
            delete currentModalEnteredCounts[clave];
            buscarArticulosLocalmente();
            actualizarVisibilidadLote();
        }
    }, { signal });

    if (selectAllCb) {
        selectAllCb.addEventListener('change', () => {
            const checked = selectAllCb.checked;
            tableBody.querySelectorAll('.fila-checkbox').forEach(cb => cb.checked = checked);
            actualizarVisibilidadLote();
        }, { signal });
    }

    if (applyBatchBtn) {
        applyBatchBtn.addEventListener('click', () => {
            const razon = batchSelect.value;
            if (!razon) {
                showCustomAlert('Selecciona una raz√≥n para aplicar.', 'info');
                return;
            }
            tableBody.querySelectorAll('.fila-checkbox:checked').forEach(cb => {
                const row = cb.closest('tr');
                const clave = row.dataset.clave;
                const select = row.querySelector('select[data-type="razon"]');
                if (select) {
                    select.value = razon;
                    actualizarConteoEnMemoria(select, clave);
                }
            });
            actualizarVisibilidadLote();
        }, { signal });
    }

    btnCerrar.addEventListener("click", async () => {
        if (Object.keys(currentModalEnteredCounts).length > 0) {
            const confirmar = await showCustomConfirm('Advertencia: hay cambios sin guardar.', 'Cerrar sin guardar', 'Continuar editando');
            if (!confirmar) return;
        }
        cerrarYLimpiarModal(false);
    }, { signal });

    submitBtn.addEventListener('click', async () => {
        if (Object.keys(currentModalEnteredCounts).length === 0) {
            showCustomAlert('Sin cambios', 'info');
            return;
        }

        const conteosARegistrar = [];
        for (const claveProducto in currentModalEnteredCounts) {
            const registro = currentModalEnteredCounts[claveProducto];
            const articuloCompleto = inventarioCompletoDelModal.find(item => item.Clave === claveProducto);
            if (!articuloCompleto) continue;

            const fisico = parseFloat(registro.fisico) || 0;
            const cpi = parseFloat(registro.cpi) || 0;
            const vpe = parseFloat(registro.vpe) || 0;
            const sistema = parseFloat(articuloCompleto.StockSistema || 0);
            const diferencia = fisico - sistema - vpe - cpi;

            conteosARegistrar.push({
                producto: articuloCompleto.Descripcion,
                diferencia
            });
        }

        if (conteosARegistrar.length === 0) {
            showCustomAlert('No hay modificaciones v√°lidas para registrar.', 'info');
            return;
        }

        let resumen = '<ul class="text-left">';
        conteosARegistrar.forEach(r => {
            resumen += `<li>${r.producto}: ${r.diferencia}</li>`;
        });
        resumen += '</ul>';

        const confirmado = await showCustomConfirm(resumen, 'Confirmar', 'Cancelar', '¬øConfirmar Registro?');
        if (!confirmado) return;

        currentModalEnteredCounts = {};
        buscarArticulosLocalmente();
        actualizarVisibilidadLote();
        showCustomAlert('√âxito', 'success', () => cerrarYLimpiarModal(true));
    }, { signal });
}

    async function cerrarModal(skipConfirm = false) {
        if (!skipConfirm && Object.keys(currentModalEnteredCounts).length > 0) {
            const confirmed = await showCustomConfirm("Has ingresado datos que no se han guardado. ¬øSeguro que quieres cerrar?");
            if (!confirmed) return;
        }

        const modalContainer = document.getElementById('modal-container');
        if (modalContainer) {
            modalContainer.classList.add('hidden');
            modalContainer.innerHTML = '';
        }
        currentModalEnteredCounts = {};
    }

    /**
     * Funci√≥n central para cargar/refrescar todos los datos del panel de admin.
     * Realiza el proceso de 2 pasos: primero carga mensajes, luego los de caja.
     */
    function refrescarPanelAdmin() {
        console.log("Iniciando refresco completo del panel de admin...");
        const panel = document.getElementById('admin-panel');
        if(panel) {
            // Mostramos un mensaje de carga mientras se ejecutan las llamadas
            document.getElementById('admin-items-container').innerHTML = `<p class="text-slate-400 text-center text-sm p-4">Cargando √≠tems...</p>`;
        }

        // PASO A: Cargar los mensajes
        google.script.run
            .withSuccessHandler(itemsIniciales => {
                console.log("Refresco - Mensajes recibidos:", itemsIniciales);
                
                // Guardamos los primeros datos
                const safeItemsIniciales = Array.isArray(itemsIniciales) ? itemsIniciales : [];
                let combinedItems = safeItemsIniciales.map(d => ({...d, fecha: d.fecha ? new Date(d.fecha) : null}));
                adminState.items = combinedItems;
                
                // Renderizamos la lista solo con mensajes para una carga r√°pida inicial
                renderFilteredAdminItems();

                // PASO B: Cargar los movimientos de caja
                google.script.run
                    .withSuccessHandler(itemsDeCaja => {
                        console.log("Refresco - Caja recibida:", itemsDeCaja);
                        const safeItemsDeCaja = Array.isArray(itemsDeCaja) ? itemsDeCaja : [];
                        const nuevosItems = safeItemsDeCaja.map(d => ({...d, fecha: d.fecha ? new Date(d.fecha) : null}));
                        
                        // Fusionamos los arrays
                        adminState.items = [...combinedItems, ...nuevosItems];
                        
                        // Re-ordenamos la lista combinada
                        adminState.items.sort((a, b) => {
                            const dateA = (a.fecha instanceof Date && !isNaN(a.fecha.getTime())) ? a.fecha.getTime() : 0;
                            const dateB = (b.fecha instanceof Date && !isNaN(b.fecha.getTime())) ? b.fecha.getTime() : 0;
                            return dateB - dateA; // De m√°s reciente a m√°s antiguo
                        });
                        
                        console.log("Refresco - Estado final fusionado:", adminState.items);
                        // Volvemos a dibujar la lista de √≠tems ya con todo fusionado y ordenado
                        renderFilteredAdminItems(); 
                    })
                    .withFailureHandler(err => console.error("Error en el Paso B (Caja):", err))
                    .obtenerMovimientosDeCaja(); 
            })
            .withFailureHandler(err => console.error("Error en el Paso A (Mensajes):", err))
            .obtenerPanelAdminData_SoloMensajes();
    }

// --- COPIA Y PEGA ESTA FUNCI√ìN COMPLETA EN TU <script> ---

/**
 * Configura la l√≥gica para los botones de navegaci√≥n m√≥vil (Chat/Panel).
 * Este es el m√©todo definitivo que manipula directamente las clases de Tailwind.
 */
    function setupMobileViewToggle() {
        const btnShowChat = document.getElementById('btn-show-chat');
        const btnShowPanel = document.getElementById('btn-show-panel');
        const chatColumn = document.getElementById('chat-column');
        const adminPanel = document.getElementById('admin-panel');

        if (!btnShowChat || !btnShowPanel || !chatColumn || !adminPanel) {
            console.error("Elementos de navegaci√≥n m√≥vil no encontrados. La vista m√≥vil no funcionar√°.");
            return;
        }

        // --- L√≥gica para el bot√≥n de CHAT ---
        btnShowChat.addEventListener('click', () => {
            if (btnShowChat.classList.contains('active')) return;

            // Ocultar el panel de admin
            adminPanel.classList.add('hidden');
            adminPanel.classList.remove('flex');

            // Mostrar la columna del chat
            chatColumn.classList.remove('hidden');
            chatColumn.classList.add('flex');

            // Actualizar el estado visual de los botones
            btnShowChat.classList.add('active');
            btnShowPanel.classList.remove('active');
        });

        // --- L√≥gica para el bot√≥n de PANEL ---
        btnShowPanel.addEventListener('click', () => {
            if (btnShowPanel.classList.contains('active')) return;
            
            // Ocultar la columna del chat
            chatColumn.classList.add('hidden');
            chatColumn.classList.remove('flex');
            
            // Mostrar el panel de admin
            adminPanel.classList.remove('hidden');
            adminPanel.classList.add('flex');

            // Actualizar el estado visual de los botones
            btnShowPanel.classList.add('active');
            btnShowChat.classList.remove('active');
        });
    }

    // =================================================================
// ==== NUEVA FUNCI√ìN PARA CONTROLAR LA VISTA (CHAT O PANEL) ====
// =================================================================
function updateActiveView(viewName) {
    // Ocultar todos los paneles primero
    chatColumn.classList.add('hidden');
    adminPanel.classList.add('hidden');

    // Resetear estilos de los botones del switcher
    showChatBtn.classList.remove('bg-blue-600', 'text-white');
    showChatBtn.classList.add('text-slate-300', 'hover:bg-slate-600');
    showAdminPanelBtn.classList.remove('bg-blue-600', 'text-white');
    showAdminPanelBtn.classList.add('text-slate-300', 'hover:bg-slate-600');

    // Mostrar el panel activo y actualizar el estilo del bot√≥n
    if (viewName === 'chat') {
        chatColumn.classList.remove('hidden');
        showChatBtn.classList.add('bg-blue-600', 'text-white');
        showChatBtn.classList.remove('text-slate-300', 'hover:bg-slate-600');
    } else if (viewName === 'admin') {
        adminPanel.classList.remove('hidden');
        showAdminPanelBtn.classList.add('bg-blue-600', 'text-white');
        showAdminPanelBtn.classList.remove('text-slate-300', 'hover:bg-slate-600');
        
        // Opcional: Refrescar el panel de admin cada vez que se muestra
        if (typeof refrescarPanelAdmin === 'function') {
            refrescarPanelAdmin();
        }
    }
}



</script>
</body>
</html>
