<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Interna - Ferretería Flores</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* Estilos Base */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }

        /* Estilo para los íconos de Material Symbols */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }

        /* Scrollbars */
        #chat-window::-webkit-scrollbar, #admin-panel::-webkit-scrollbar, #sidebar-scroll-area::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track, #admin-panel::-webkit-scrollbar-track, #sidebar-scroll-area::-webkit-scrollbar-track { background: #1e293b; }
        #chat-window::-webkit-scrollbar-thumb, #admin-panel::-webkit-scrollbar-thumb, #sidebar-scroll-area::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        #chat-window::-webkit-scrollbar-thumb:hover, #admin-panel::-webkit-scrollbar-thumb:hover, #sidebar-scroll-area::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Animaciones del Chat */
        .message-bubble { opacity: 0; transform: translateY(20px); animation: slide-up 0.4s ease-out forwards; }
        @keyframes slide-up { to { opacity: 1; transform: translateY(0); } }
        .typing-dot { width: 8px; height: 8px; background-color: #94a3b8; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /* Sugerencias de Autocompletar */
        .suggestion-item {
            background-color: #334155; border: 1px solid #475569; color: #e2e8f0;
            padding: 8px 12px; margin-top: 4px; border-radius: 8px; cursor: pointer;
            text-align: left; width: 100%; transition: background-color 0.2s;
        }
        .suggestion-item:hover { background-color: #475569; }

        /* Estilos del Panel de Admin */
        .admin-tab-btn {
            padding: 6px 12px; border-radius: 9999px; background-color: #334155;
            color: #e2e8f0; font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out; border: none;
        }
        .admin-tab-btn:hover { background-color: #475569; }
        .admin-tab-btn.active { background-color: #f59e0b; color: #000; font-weight: bold; }
        .row-diff-positive { background-color: #d1fae5; }
        .row-diff-negative { background-color: #ffe4e6; }
        .diff-positive { color: #22c55e; }
        .diff-negative { color: #ef4444; }
        .diff-zero { color: #64748b; }

        /* Animación para resaltar fila */
        @keyframes highlight-fade {
            from { background-color: #f59e0b40; }
            to { background-color: transparent; }
        }
        .highlight-row {
            animation: highlight-fade 3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 flex justify-center items-center min-h-screen">

<!-- ===== PANTALLA DE LOGIN ===== -->
<div id="login-card" class="w-full max-w-sm">
    <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl text-center">
        <h1 class="text-2xl mb-2 font-bold text-white">Acceso a Plataforma</h1>
        <p class="text-slate-400 mb-6 text-sm">Ferretería Flores</p>
        <div class="mb-4">
            <input id="inputID" type="text" placeholder="Ingresa tu ID (ej. U001)" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-300 text-center" />
        </div>
        <div class="mb-4">
            <input id="inputPIN" type="password" placeholder="Ingresa tu PIN" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-300 text-center" />
        </div>
        <button id="btnLogin" class="w-full bg-emerald-500 hover:bg-emerald-600 px-6 py-2.5 rounded-lg text-white font-semibold transition duration-300 disabled:bg-slate-600">
            Entrar
        </button>
        <p id="loginMsg" class="mt-4 text-red-400 text-xs h-4"></p>
    </div>
</div>

<!-- ===== CONTENEDOR PRINCIPAL DE LA APP (OCULTO INICIALMENTE) ===== -->
<div id="app-container" class="flex h-screen w-screen hidden">

    <!-- ===== BARRA LATERAL (IZQUIERDA) ===== -->
    <aside class="w-80 bg-slate-900/50 flex flex-col p-4 border-r border-slate-800">
        <div class="flex-shrink-0 text-center mb-6">
            <h1 class="text-xl font-bold text-white">Ferretería Flores</h1>
            <p class="text-xs text-emerald-400">Plataforma Interna</p>
        </div>

        <div id="sidebar-scroll-area" class="flex-grow flex flex-col space-y-6 overflow-y-auto pr-2 -mr-2">
            <div id="user-info-area" class="flex-shrink-0 text-center bg-slate-800 p-4 rounded-xl shadow-lg">
                <p id="user-name-display" class="text-lg font-semibold text-white">Cargando...</p>
                <p id="user-details-display" class="text-xs text-slate-400">...</p>
            </div>

            <div id="scoreboard-container" class="flex-shrink-0 bg-slate-800 p-4 rounded-xl shadow-lg">
                <h3 class="text-sm font-semibold text-slate-300 mb-3">Puntajes y Clasificación</h3>
                <div class="flex justify-between items-center bg-slate-700/50 p-2 rounded-lg mb-3">
                    <p class="font-semibold text-white">Tu Puntaje</p>
                    <p id="puntos-actuales" class="text-2xl font-bold text-yellow-400">0</p>
                </div>
                <div id="ranking-list" class="space-y-1 text-sm"></div>
            </div>

            <div id="quick-starters" class="flex-grow flex flex-col space-y-2">
                <h3 class="text-sm font-semibold text-slate-400 pb-2">Acciones Rápidas</h3>
                <!-- Los botones se generan aquí con JavaScript -->
            </div>
        </div>

        <div class="flex-shrink-0 pt-6">
            <button id="logoutBtn" class="w-full bg-slate-800 hover:bg-red-600/20 text-red-400 font-bold py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center focus:outline-none focus-visible:ring-2 focus-visible:ring-red-500">
                <span class="material-symbols-outlined mr-2">logout</span> Cerrar Sesión
            </button>
        </div>
    </aside>

    <!-- ===== ÁREA DE CONTENIDO PRINCIPAL (DERECHA) ===== -->
    <main class="flex-1 flex flex-col bg-slate-800">
        <header id="main-header" class="p-3 border-b border-slate-700 flex justify-end items-center">
            <div id="admin-view-switcher" class="flex items-center p-1 bg-slate-700 rounded-lg hidden">
                <button id="showChatBtn" class="px-3 py-1 rounded-md text-xs font-semibold">Chat</button>
                <button id="showAdminPanelBtn" class="px-3 py-1 rounded-md text-xs font-semibold">Panel</button>
            </div>
        </header>

        <!-- Contenedor para las vistas que se pueden intercambiar -->
        <div class="flex-1 flex overflow-hidden">
            <div id="chat-column" class="flex flex-col flex-1 bg-slate-800 overflow-hidden">
                <main id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-6" aria-live="polite"></main>
                <div id="suggestions-container" class="px-4 pb-2"></div>
                <footer class="p-4 border-t border-slate-700">
                    <form id="chat-form" class="relative">
                        <input type="text" id="message-input" placeholder="Escribe tu mensaje aquí..." class="w-full bg-slate-700 border border-slate-600 rounded-xl py-3 pl-4 pr-12 text-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow" autocomplete="off">
                        <button type="submit" id="send-button" class="absolute right-2 top-1/2 -translate-y-1/2 bg-emerald-600 hover:bg-emerald-500 w-9 h-9 rounded-lg flex items-center justify-center transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-800 focus-visible:ring-white" aria-label="Enviar Mensaje">
                            <span class="material-symbols-outlined text-white">send</span>
                        </button>
                    </form>
                </footer>
            </div>
            <div id="admin-panel" class="hidden flex-col flex-1 bg-slate-800 overflow-y-auto"></div>
        </div>
    </main>
</div>

<!-- ===== CONTENEDORES DE MODALES (FUERA DEL FLUJO PRINCIPAL) ===== -->
<div id="modal-container" class="fixed inset-0 bg-slate-900 bg-opacity-75 hidden flex justify-center items-center p-4 z-50"></div>
<div id="custom-alert-modal" class="fixed inset-0 bg-slate-900 bg-opacity-80 hidden justify-center items-center p-4 z-[100]">
    <div class="bg-slate-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full max-h-[80vh] overflow-y-auto">
        <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-white"></h3>
        <p id="custom-alert-message" class="text-slate-300 mb-6 whitespace-pre-line"></p>
        <button id="custom-alert-close-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Aceptar</button>
    </div>
</div>
<div id="custom-confirm-modal" class="fixed inset-0 bg-slate-900 bg-opacity-80 hidden justify-center items-center p-4 z-[100]">
    <div class="bg-slate-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
        <h3 id="custom-confirm-title" class="text-xl font-bold mb-4 text-white">Confirmación</h3>
        <p id="custom-confirm-message" class="text-slate-300 mb-6"></p>
        <div class="flex justify-center gap-4">
            <button id="custom-confirm-yes-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">Sí</button>
            <button id="custom-confirm-no-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg">No</button>
        </div>
    </div>
</div>

<script>
// =========================================================================
// ================ SCRIPT FINAL Y UNIFICADO PARA INDEX.HTML ===============
// =========================================================================
document.addEventListener('DOMContentLoaded', () => {

    // --- Elementos del Frontend ---
    const loginCard = document.getElementById('login-card');
    const appContainer = document.getElementById('app-container');
    const btnLogin = document.getElementById('btnLogin');
    const inputID = document.getElementById('inputID');
    const inputPIN = document.getElementById('inputPIN');
    const loginMsg = document.getElementById('loginMsg');

    // Barra Lateral
    const userNameDisplay = document.getElementById('user-name-display');
    const userDetailsDisplay = document.getElementById('user-details-display');
    const scoreboardContainer = document.getElementById('scoreboard-container');
    const puntosActuales = document.getElementById('puntos-actuales');
    const rankingList = document.getElementById('ranking-list');
    const quickStartersContainer = document.getElementById('quick-starters');
    const logoutBtn = document.getElementById('logoutBtn');

    // Contenido Principal
    const adminViewSwitcher = document.getElementById('admin-view-switcher');
    const showChatBtn = document.getElementById('showChatBtn');
    const showAdminPanelBtn = document.getElementById('showAdminPanelBtn');
    const chatColumn = document.getElementById('chat-column');
    const adminPanel = document.getElementById('admin-panel');
    const chatWindow = document.getElementById('chat-window');
    const suggestionsContainer = document.getElementById('suggestions-container');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    // Modales
    const modalContainer = document.getElementById('modal-container');
    const alertModal = document.getElementById('custom-alert-modal');
    const alertTitle = document.getElementById('custom-alert-title');
    const alertMessage = document.getElementById('custom-alert-message');
    const alertCloseBtn = document.getElementById('custom-alert-close-btn');
    const confirmModal = document.getElementById('custom-confirm-modal');
    const confirmTitle = document.getElementById('custom-confirm-title');
    const confirmMessage = document.getElementById('custom-confirm-message');
    const confirmYesBtn = document.getElementById('custom-confirm-yes-btn');
    const confirmNoBtn = document.getElementById('custom-confirm-no-btn');

    // --- Estado Global ---
    let perfilActual = null;
    let adminState = { items: [], filters: { tipo: 'Todos', fecha: '' } };
    let herramientaPendiente = null;
    let quickStarterEnUso = null;
    let intentosFallidos = {};
    const MAX_INTENTOS_HERRAMIENTA = 3;

    // --- Lógica de Modales (Alert y Confirm) ---
    function showCustomAlert(message, type = 'info', onClose) {
        alertMessage.textContent = message;
        alertModal.classList.remove('hidden');
        alertModal.classList.add('flex');
        let title = 'Información';
        if (type === 'success') title = 'Éxito';
        if (type === 'error') title = 'Error';
        alertTitle.textContent = title;
        alertCloseBtn.onclick = () => {
            alertModal.classList.add('hidden');
            if (typeof onClose === 'function') onClose();
        };
    }

    function showCustomConfirm(message, yesText = 'Sí', noText = 'No', title = 'Confirmación') {
        return new Promise((resolve) => {
            confirmMessage.innerHTML = message;
            confirmTitle.textContent = title;
            confirmYesBtn.textContent = yesText;
            confirmNoBtn.textContent = noText;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
            const closeConfirm = (result) => {
                confirmModal.classList.add('hidden');
                resolve(result);
            };
            confirmYesBtn.onclick = () => closeConfirm(true);
            confirmNoBtn.onclick = () => closeConfirm(false);
        });
    }

    // --- Lógica de Login e Inicialización ---
    const storedProfile = sessionStorage.getItem('perfil');
    if (storedProfile) {
        inputID.value = JSON.parse(storedProfile).UsuarioID;
        // El PIN no se guarda por seguridad, el usuario debe reingresarlo
    } else {
        const localSession = localStorage.getItem('sessionId');
        const localExpire = parseInt(localStorage.getItem('sessionExpires'), 10);
        const localProfile = localStorage.getItem('perfil');
        if (localSession && localProfile && localExpire && Date.now() < localExpire) {
            btnLogin.disabled = true;
            google.script.run
                .withSuccessHandler(datos => {
                    if (datos.ok) {
                        procesarDatosIniciales(datos);
                    } else {
                        localStorage.removeItem('perfil');
                        localStorage.removeItem('sessionId');
                        localStorage.removeItem('sessionExpires');
                        btnLogin.disabled = false;
                    }
                })
                .reutilizarSesionActiva(JSON.parse(localProfile).UsuarioID, localSession);
        }
    }

    btnLogin.addEventListener('click', () => {
        const id = inputID.value.trim().toUpperCase();
        const pin = inputPIN.value.trim();
        if (!id || !pin) {
            showCustomAlert("Por favor, ingresa tu ID y tu PIN.", 'info');
            return;
        }
        loginMsg.textContent = "Validando...";
        btnLogin.disabled = true;

        google.script.run
            .withSuccessHandler(procesarDatosIniciales)
            .withFailureHandler(err => {
                showCustomAlert(`Error de Login: ${err.message}`, 'error');
                btnLogin.disabled = false;
                loginMsg.textContent = '';
            })
            .cargarDatosIniciales(id, pin);
    });

    function procesarDatosIniciales(datos) {
        if (!datos.ok) {
            showCustomAlert(datos.msg || "Credenciales incorrectas.", 'error');
            btnLogin.disabled = false;
            loginMsg.textContent = '';
            return;
        }

        sessionStorage.setItem('perfil', JSON.stringify(datos.perfil));
        sessionStorage.setItem('sessionId', datos.sesionId);
        const expiration = Date.now() + 12 * 60 * 60 * 1000;
        localStorage.setItem('perfil', JSON.stringify(datos.perfil));
        localStorage.setItem('sessionId', datos.sesionId);
        localStorage.setItem('sessionExpires', String(expiration));
        perfilActual = datos.perfil;

        loginCard.classList.add('hidden');
        appContainer.classList.remove('hidden');
        appContainer.classList.add('flex');

        // Renderizar UI
        userNameDisplay.textContent = perfilActual.Nombre;
        userDetailsDisplay.textContent = `Sucursal: ${perfilActual.Sucursal} | Rol: ${perfilActual.Rol}`;
        renderQuickStarters(datos.quickStarters);
        actualizarPuntajeYRanking();

        if (datos.mensajeAnuncio && Array.isArray(datos.mensajeAnuncio)) {
            datos.mensajeAnuncio.forEach((msg, i) => setTimeout(() => addMessage(msg, 'system'), 500 * (i + 1)));
        }

        adminViewSwitcher.classList.remove('hidden');
        showChatBtn.addEventListener('click', () => updateActiveView('chat'));
        showAdminPanelBtn.addEventListener('click', () => updateActiveView('admin'));
        updateActiveView('chat');
        renderAdminPanel();
        refrescarPanelAdmin();

        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    }

    // --- Lógica de Chat ---
    function addMessage(text, sender) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `flex message-bubble ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
        let bubbleClasses = 'max-w-md lg:max-w-xl rounded-2xl px-4 py-2.5 text-sm shadow-md ';
        let bubbleContent = `<p>${text.replace(/\n/g, '<br>')}</p>`;

        if (sender === 'user') {
            bubbleClasses += 'bg-blue-600 text-white';
        } else if (sender === 'ai') {
            bubbleClasses += 'bg-slate-700 text-slate-200';
        } else { // system
            bubbleClasses += 'bg-slate-700/50 border border-slate-600/50 text-slate-400 w-full';
            bubbleContent = `<div class="flex items-center gap-2"><span class="material-symbols-outlined text-emerald-500 text-base">auto_awesome</span><p class="font-mono text-xs">${text}</p></div>`;
        }
        messageContainer.innerHTML = `<div class="${bubbleClasses}">${bubbleContent}</div>`;
        chatWindow.appendChild(messageContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showTypingIndicator() {
        if (document.getElementById('typing-indicator')) return;
        const indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'flex justify-start message-bubble';
        indicator.innerHTML = `<div class="bg-slate-700 text-slate-200 rounded-2xl px-4 py-2.5 shadow-md"><div class="flex items-center gap-1.5"><span class="typing-dot"></span><span class="typing-dot" style="animation-delay: 0.2s;"></span><span class="typing-dot" style="animation-delay: 0.4s;"></span></div></div>`;
        chatWindow.appendChild(indicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function hideTypingIndicator() {
        document.getElementById('typing-indicator')?.remove();
    }

    function getAIResponse(payload) {
        messageInput.disabled = true;
        sendButton.disabled = true;
        showTypingIndicator();

        const userIdToPass = perfilActual?.UsuarioID;
        const sessionIdToPass = sessionStorage.getItem('sessionId');

        if (!userIdToPass || !sessionIdToPass) {
            hideTypingIndicator();
            showCustomAlert("⚠️ La sesión de usuario no está activa o se ha perdido. Por favor, intentá cerrar sesión y volver a entrar.", 'error');
            messageInput.disabled = false;
            sendButton.disabled = false;
            return;
        }

        if (!payload.tool_name && quickStarterEnUso) {
            payload.tool_name = quickStarterEnUso.nombreFuncion;
        }

        google.script.run
            .withSuccessHandler(handleAIResponse)
            .withFailureHandler(handleAIError)
            .enviarAOpenAI(sessionIdToPass, userIdToPass, payload);
    }

    function handleAIResponse(data) {
        hideTypingIndicator();

        if (data.content) {
            addMessage(data.content, 'ai');
        }

        const registroRegex = /(?:ya\s+)?(?:registr(?:e|é)|qued(?:o|ó)\s+registrado|registro\s+completado)/i;
        const esPregunta = /[¿?]/.test(data.content);
        if (!data.tool_call && data.content && registroRegex.test(data.content) && !esPregunta) {
            const herramienta = quickStarterEnUso?.nombreFuncion || 'N/D';
            const claveIntento = `${sessionStorage.getItem('sessionId')}-${herramienta}`;
            const intentos = (intentosFallidos[claveIntento] || 0) + 1;
            intentosFallidos[claveIntento] = intentos;
            google.script.run.Logging.logError(
                'Frontend',
                'handleAIResponse',
                'Texto de registro sin tool_call',
                '',
                `${herramienta} | intento ${intentos} | ${data.content}`,
                perfilActual?.UsuarioID || 'N/A'
            );
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
            if (intentos >= MAX_INTENTOS_HERRAMIENTA) {
                quickStarterEnUso = null;
                showCustomAlert('No se pudo completar el registro tras varios intentos. Por favor, realizá la acción manualmente.', 'error');
            } else if (quickStarterEnUso) {
                showCustomConfirm(`El registro no se completó. ¿Reintentar \"${quickStarterEnUso.nombrePantalla}\"?`, 'Reintentar', 'Cancelar')
                    .then(reintentar => {
                        if (reintentar) {
                            getAIResponse({ texto: quickStarterEnUso.nombrePantalla, tool_name: quickStarterEnUso.nombreFuncion });
                        }
                    });
            } else {
                showCustomAlert('El registro no se completó. Por favor, repetí el proceso.', 'error');
            }
            return;
        }

        if (data.tool_call) {
            const toolCall = data.tool_call;
            const functionName = toolCall.function.name;
            const claveIntento = `${sessionStorage.getItem('sessionId')}-${functionName}`;
            delete intentosFallidos[claveIntento];
            quickStarterEnUso = null;
            let functionArgs;
            try {
                functionArgs = JSON.parse(toolCall.function.arguments);
            } catch (e) {
                showCustomAlert('La respuesta de la IA fue inválida.', 'error');
                google.script.run.Logging.logError(
                    'Frontend',
                    'handleAIResponse',
                    'Error al parsear argumentos',
                    toolCall.function.arguments,
                    e.message,
                    perfilActual?.UsuarioID || 'N/A'
                );
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
                return;
            }

            if (functionName === 'registrarConteo') {
                herramientaPendiente = {
                    id: toolCall.id,
                    name: functionName,
                    args: functionArgs
                };
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            } else {
                addMessage(`Ejecutando: ${functionName}...`, 'system');

                const userId = perfilActual.UsuarioID;
                const sessionId = sessionStorage.getItem('sessionId');

                google.script.run
                    .withSuccessHandler(functionResult => {
                        addMessage(`Resultado: ${functionResult}`, 'system');
                        actualizarPuntajeYRanking();

                        const payloadForNextStep = {
                            texto: null,
                            tool_response: {
                                tool_call_id: toolCall.id,
                                function_name: functionName,
                                result: functionResult
                            }
                        };
                        getAIResponse(payloadForNextStep);
                    })
                    .withFailureHandler(error => {
                        const errorMessage = `Error al ejecutar la herramienta ${functionName}: ${error.message}`;
                        addMessage(`Resultado: ${errorMessage}`, 'system');
                        const payloadForNextStep = {
                            texto: null,
                            tool_response: {
                                tool_call_id: toolCall.id,
                                function_name: functionName,
                                result: errorMessage
                            }
                        };
                        getAIResponse(payloadForNextStep);
                    })
                    .ejecutarHerramienta(functionName, functionArgs, userId, sessionId);
            }
        } else {
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }
    }

    function handleAIError(error) {
        hideTypingIndicator();
        showCustomAlert(`Ocurrió un error al procesar tu solicitud: ${error.message}.`, 'error');
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    }

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const userInput = messageInput.value.trim();
        if (!userInput) return;

        addMessage(userInput, 'user');
        messageInput.value = '';

        // Expresiones para interpretar respuestas positivas o negativas
        const affirmativePattern = /^(?:s[ií]p?|claro|dale|ok(?:ay|ey)?|va|vale|listo|de acuerdo|afirmativo)/i;
        const negativePattern = /^(?:no|nop|nope|cancel(?:ar|ado)?|cancela|cancelaci(?:ó|o)n|negativo)/i;

        if (herramientaPendiente && affirmativePattern.test(userInput)) {
            const pending = herramientaPendiente;
            herramientaPendiente = null;
            showTypingIndicator();
            const userId = perfilActual.UsuarioID;
            const sessionId = sessionStorage.getItem('sessionId');
            google.script.run
                .withSuccessHandler(functionResult => {
                    addMessage(`Resultado: ${functionResult}`, 'system');
                    actualizarPuntajeYRanking();
                    const payloadForNextStep = {
                        texto: null,
                        tool_response: {
                            tool_call_id: pending.id,
                            function_name: pending.name,
                            result: functionResult
                        }
                    };
                    getAIResponse(payloadForNextStep);
                })
                .withFailureHandler(error => {
                    hideTypingIndicator();
                    showCustomAlert(`Ocurrió un error al procesar tu solicitud: ${error.message}.`, 'error');
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    messageInput.focus();
                    const tool_response = {
                        tool_call_id: pending.id,
                        function_name: pending.name,
                        result: `Error al ejecutar la herramienta: ${error.message}`
                    };
                    getAIResponse({ texto: null, tool_response });
                })
                .ejecutarHerramienta(pending.name, pending.args, userId, sessionId);
        } else if (herramientaPendiente && negativePattern.test(userInput)) {
            const pending = herramientaPendiente;
            herramientaPendiente = null;
            addMessage('Operación cancelada.', 'system');
            const tool_response = {
                tool_call_id: pending.id,
                function_name: pending.name,
                result: 'Operación cancelada'
            };
            getAIResponse({ texto: null, tool_response });
        } else {
            getAIResponse({ texto: userInput });
        }
    });

    // --- Lógica de Quick Starters ---
    function renderQuickStarters(starters) {
        quickStartersContainer.innerHTML = '<h3 class="text-sm font-semibold text-slate-400 pb-2">Acciones Rápidas</h3>';
        if (!starters || starters.length === 0) return;

        const icons = {
            registrarProblema: 'report',
            registrarSugerencia: 'lightbulb',
            registrarConteo: 'inventory_2',
            registrarIngresoCaja: 'attach_money',
            registrarEgresoCaja: 'money_off',
            arqueoCaja: 'calculate',
            generarResumenAdmin: 'analytics',
            default: 'play_circle'
        };

        starters.forEach(starter => {
            const button = document.createElement('button');
            button.className = "w-full text-left bg-slate-800 hover:bg-slate-700 text-slate-200 p-3 rounded-lg flex items-center transition-colors duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500";
            button.dataset.functionName = starter.NombreFuncion;

            const iconName = icons[starter.NombreFuncion] || icons.default;
            button.innerHTML = `<span class="material-symbols-outlined mr-3">${iconName}</span> <span class="font-medium text-sm">${starter.NombrePantalla}</span>`;

            button.addEventListener('click', () => {
                if (starter.NombreFuncion === 'registrarConteo') {
                    if (typeof abrirModalDeConteo === 'function') {
                        abrirModalDeConteo();
                    } else {
                        showCustomAlert('La función para registrar conteo no está disponible.', 'error');
                    }
                } else {
                    addMessage(starter.NombrePantalla, 'user');
                    quickStarterEnUso = { nombreFuncion: starter.NombreFuncion, nombrePantalla: starter.NombrePantalla };
                    getAIResponse({ texto: starter.NombrePantalla, tool_name: starter.NombreFuncion });
                }
            });
            quickStartersContainer.appendChild(button);
        });
    }

    // --- Lógica de Puntajes ---
    function actualizarPuntajeYRanking() {
        google.script.run
            .withSuccessHandler(datos => {
                if (!Array.isArray(datos)) return;

                const currentUserData = datos.find(u => u.UsuarioID === perfilActual.UsuarioID);
                if (currentUserData) {
                    puntosActuales.textContent = (currentUserData.Puntos || 0).toLocaleString('es-NI');
                }

                rankingList.innerHTML = '';
                datos.sort((a,b) => (b.Puntos || 0) - (a.Puntos || 0)).forEach(user => {
                    const esUsuarioActual = user.UsuarioID === perfilActual.UsuarioID;
                    const row = document.createElement('div');
                    row.className = `flex justify-between items-center p-1.5 rounded-md ${esUsuarioActual ? 'bg-blue-600/20' : ''}`;
                    row.innerHTML = `
                        <span class="font-medium ${esUsuarioActual ? 'text-blue-300' : 'text-slate-300'}">${user.Nombre || user.UsuarioID}</span>
                        <span class="font-bold text-slate-200">${(user.Puntos || 0).toLocaleString('es-NI')}</span>
                    `;
                    rankingList.appendChild(row);
                });
            })
            .obtenerRankingPuntos();
    }

    // --- Lógica del Panel de Admin ---
    function updateActiveView(viewName) {
        chatColumn.classList.add('hidden');
        adminPanel.classList.add('hidden');
        showChatBtn.classList.remove('bg-emerald-600', 'text-white');
        showAdminPanelBtn.classList.remove('bg-emerald-600', 'text-white');
        showChatBtn.classList.add('text-slate-300');
        showAdminPanelBtn.classList.add('text-slate-300');

        if (viewName === 'chat') {
            chatColumn.classList.remove('hidden');
            showChatBtn.classList.add('bg-emerald-600', 'text-white');
        } else if (viewName === 'admin') {
            adminPanel.classList.remove('hidden');
            showAdminPanelBtn.classList.add('bg-emerald-600', 'text-white');
            refrescarPanelAdmin();
        }
    }

    function renderAdminPanel() {
        adminPanel.innerHTML = `
            <div class="p-4 sticky top-0 bg-slate-800 border-b border-slate-700 z-10">
                <h2 class="text-lg font-bold text-white mb-4">Panel de Administración</h2>
                <div id="admin-filter-tabs" class="flex gap-2 flex-wrap text-sm mb-3">
                    <button data-tipo="Todos" class="admin-tab-btn active">Todos</button>
                    <button data-tipo="Problema" class="admin-tab-btn">Problemas</button>
                    <button data-tipo="Sugerencia" class="admin-tab-btn">Sugerencias</button>
                    <button data-tipo="Tarea" class="admin-tab-btn">Tareas</button>
                    <button data-tipo="Caja" class="admin-tab-btn">Caja</button>
                </div>
                <input type="date" id="admin-filter-fecha" class="w-full bg-slate-700 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-3">
                <div class="flex gap-2">
                    <input type="number" id="admin-resumen-dias" min="1" max="7" value="1" class="w-full bg-slate-700 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="Días a resumir">
                    <button id="generar-resumen-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg px-4 py-1.5 text-sm">Generar Resumen</button>
                </div>
            </div>
            <div id="admin-items-container" class="p-4 space-y-3"></div>
        `;

        adminPanel.querySelector('#admin-filter-fecha').addEventListener('change', (e) => {
            adminState.filters.fecha = e.target.value;
            renderFilteredAdminItems();
        });

        adminPanel.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                adminPanel.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                adminState.filters.tipo = btn.dataset.tipo;
                renderFilteredAdminItems();
            });
        });

        adminPanel.querySelector('#generar-resumen-btn').addEventListener('click', () => {
            const dias = parseInt(document.getElementById('admin-resumen-dias').value, 10) || 1;
            google.script.run
                .withSuccessHandler(resumen => showCustomAlert(resumen, 'info'))
                .withFailureHandler(error => showCustomAlert('Error al cargar resumen: ' + error.message, 'error'))
                .generarResumenAdmin(dias);
        });
    }

    function refrescarPanelAdmin() {
        const container = document.getElementById('admin-items-container');
        if (container) {
            container.innerHTML = `<p class="text-slate-400 text-center text-sm p-4">Cargando ítems...</p>`;
        }
        google.script.run
            .withSuccessHandler(mensajes => {
                google.script.run
                    .withSuccessHandler(caja => {
                        const listaMensajes = Array.isArray(mensajes) ? mensajes : [];
                        const listaCaja = Array.isArray(caja) ? caja : [];
                        adminState.items = [...listaMensajes, ...listaCaja]
                            .map(d => ({...d, fecha: d.fecha ? new Date(d.fecha) : null}));
                        adminState.items.sort((a, b) => (b.fecha?.getTime() || 0) - (a.fecha?.getTime() || 0));
                        renderFilteredAdminItems();
                    })
                    .withFailureHandler(err => {
                        if (container) {
                            container.innerHTML = `<p class="text-red-400 text-center text-sm p-4">Error al cargar caja: ${err.message}</p>`;
                        }
                    })
                    .obtenerMovimientosDeCaja();
            })
            .withFailureHandler(err => {
                if (container) {
                    container.innerHTML = `<p class="text-red-400 text-center text-sm p-4">Error al cargar datos: ${err.message}</p>`;
                }
            })
            .obtenerPanelAdminData_SoloMensajes(perfilActual.UsuarioID);
    }

    function renderFilteredAdminItems() {
        const container = document.getElementById('admin-items-container');
        if (!container) return;

        let itemsToShow = [...adminState.items];
        if (adminState.filters.tipo !== 'Todos') {
            itemsToShow = itemsToShow.filter(item => item.tipo === adminState.filters.tipo);
        }
        if (adminState.filters.fecha) {
            const filterDate = new Date(adminState.filters.fecha);
            itemsToShow = itemsToShow.filter(item => item.fecha?.toDateString() === filterDate.toDateString());
        }

        if (itemsToShow.length === 0) {
            container.innerHTML = '<p class="text-slate-400 text-center text-sm p-4">No hay ítems que coincidan.</p>';
            return;
        }

        container.innerHTML = itemsToShow.map(item => {
            const statusColor = item.estado === 'Pendiente' ? 'bg-yellow-500/20 text-yellow-300' : 'bg-green-500/20 text-green-300';
            const tipoIcono = { Problema: 'report', Sugerencia: 'lightbulb', Tarea: 'task_alt', Caja: 'payments' }[item.tipo] || 'folder';
            return `
                <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-white text-sm pr-2 flex items-center"><span class="material-symbols-outlined text-base mr-2">${tipoIcono}</span> ${item.asunto || 'Sin asunto'}</p>
                        <span class="text-xs ${statusColor} px-2 py-0.5 rounded-full whitespace-nowrap">${item.estado}</span>
                    </div>
                    <p class="text-xs text-slate-400 mt-1 mb-2 break-words">${item.detalle || ''}</p>
                    <div class="flex justify-between items-center text-xs text-slate-500">
                        <span>${item.usuario || 'N/A'} - ${item.fecha?.toLocaleDateString('es-NI') || 'Sin fecha'}</span>
                        ${item.estado === 'Pendiente' ? `<button data-item-id="${item.id}" class="btn-marcar-revisado px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs">Marcar Revisado</button>` : ''}
                    </div>
                </div>`;
        }).join('');

        container.querySelectorAll('.btn-marcar-revisado').forEach(btn => {
            btn.addEventListener('click', () => {
                const itemId = btn.dataset.itemId;
                showCustomConfirm(`¿Seguro que quieres marcar el ítem ${itemId} como 'Revisado'?`)
                    .then(confirmed => {
                        if (confirmed) {
                            google.script.run
                                .withSuccessHandler(response => {
                                    showCustomAlert(response, 'success');
                                    refrescarPanelAdmin();
                                })
                                .withFailureHandler(err => showCustomAlert(err.message, 'error'))
                                .actualizarEstadoItemAdmin(itemId, 'Revisado');
                        }
                    });
            });
        });
    }

    // --- Lógica de Autocompletar con @ ---
    messageInput.addEventListener('input', () => {
        const text = messageInput.value;
        const atIndex = text.lastIndexOf('@');
        if (atIndex !== -1) {
            const query = text.substring(atIndex + 1);
            if (query.length >= 2) {
                google.script.run
                    .withSuccessHandler(displaySuggestions)
                    .buscarArticulo(query);
            } else {
                suggestionsContainer.innerHTML = '';
            }
        } else {
            suggestionsContainer.innerHTML = '';
        }
    });

    function displaySuggestions(suggestions) {
        suggestionsContainer.innerHTML = '';
        if (suggestions && suggestions.length > 0) {
            suggestions.forEach(suggestion => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'suggestion-item';
                item.textContent = suggestion;
                item.onclick = () => selectSuggestion(suggestion);
                suggestionsContainer.appendChild(item);
            });
        }
    }

    function selectSuggestion(suggestion) {
        const text = messageInput.value;
        const atIndex = text.lastIndexOf('@');
        messageInput.value = text.substring(0, atIndex) + suggestion + ' ';
        suggestionsContainer.innerHTML = '';
        messageInput.focus();
    }

    // --- Lógica de Logout ---
    logoutBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm("¿Seguro que quieres cerrar sesión?");
        if (confirmed) {
            sessionStorage.clear();
            localStorage.removeItem('perfil');
            localStorage.removeItem('sessionId');
            localStorage.removeItem('sessionExpires');
            location.reload();
        }
    });

    // =========================================================
    // --- INICIO DE LA LÓGICA DEL MODAL DE CONTEO (RESTAURADA) ---
    // =========================================================
    let editedData = {};
    let inventoryData = [];
    let currentFilter = 'hoy';
    let hasSearched = false;
    const RAZONES_AJUSTE = ["Entrega incorrecta", "Recepción incorrecta", "Devolución de cliente", "Devolución de proveedor", "Ajuste de inventario", "Merma", "Otro"];
    const itemsPerPage = 20;
    let currentPage = 1;
    let totalPages = 1;

    function abrirModalDeConteo() {
        google.script.run
            .withSuccessHandler(html => {
                modalContainer.innerHTML = html;
                modalContainer.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                inicializarModal();
            })
            .withFailureHandler(err => showCustomAlert('Error al cargar el modal: ' + err.message, 'error'))
            .abrirModalDeConteo();
    }
    window.abrirModalDeConteo = abrirModalDeConteo;

    function inicializarModal() {
        // --- INYECCIÓN DEL BUSCADOR RÁPIDO ---
        const modalHeader = document.querySelector('#modal-container h2').parentElement;
        if(modalHeader){
            const searchContainer = document.createElement('div');
            searchContainer.className = 'flex items-center gap-2 mt-2 sm:mt-0';
            searchContainer.innerHTML = `
                <input type="text" id="quick-find-input" placeholder="Buscar Clave y Enter" class="bg-gray-200 border border-gray-400 rounded-md px-3 py-1 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <button id="quick-find-btn" class="p-1.5 bg-emerald-600 hover:bg-emerald-700 rounded-md text-white"><span class="material-symbols-outlined text-base">search</span></button>
            `;
            modalHeader.appendChild(searchContainer);
            document.getElementById('quick-find-btn').addEventListener('click', jumpToItem);
            document.getElementById('quick-find-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') jumpToItem();
            });
        }
        // --- FIN DE LA INYECCIÓN ---

        document.getElementById('close-modal-button').addEventListener('click', cerrarModalDeConteo);
        document.getElementById('print-list-button').addEventListener('click', imprimirTabla);
        document.getElementById('register-counts-button').addEventListener('click', registrarConteos);
        document.getElementById('search-inventory-input').addEventListener('keydown', handleSearch);
        document.querySelectorAll('.inventory-filter-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                currentFilter = e.target.dataset.filter;
                document.getElementById('search-inventory-input').value = '';
                hasSearched = true;
                actualizarBotonesFiltro();
                cargarYRenderizarInventario();
            });
        });
        document.getElementById('apply-batch-reason-btn').addEventListener('click', aplicarRazonEnLote);
        const batchReasonSelect = document.getElementById('batch-reason-select');
        batchReasonSelect.innerHTML = `<option value="">Seleccionar...</option>` + RAZONES_AJUSTE.map(r => `<option value="${r}">${r}</option>`).join('');
        hasSearched = false;
        inventoryData = [];
        renderizarTabla();
    }

    function jumpToItem() {
        const searchTerm = document.getElementById('quick-find-input').value.trim().toUpperCase();
        if (!searchTerm) return;

        const itemIndex = inventoryData.findIndex(item => item.Clave.toUpperCase() === searchTerm);

        if (itemIndex === -1) {
            showCustomAlert(`No se encontró ningún artículo con la clave "${searchTerm}".`, 'error');
            return;
        }

        const targetPage = Math.floor(itemIndex / itemsPerPage) + 1;
        renderPage(targetPage);

        // Resaltar la fila
        setTimeout(() => {
            const row = document.querySelector(`tr[data-clave="${searchTerm.toUpperCase()}"]`);
            if (row) {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                row.classList.add('highlight-row');
                setTimeout(() => row.classList.remove('highlight-row'), 3000);
            }
        }, 100); // Pequeño delay para asegurar que el DOM está actualizado
    }

    function cargarYRenderizarInventario() {
        const query = document.getElementById('search-inventory-input').value;
        const tableBody = document.getElementById('inventory-table-body');
        if(tableBody) tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-gray-500">Cargando datos...</td></tr>`;

        google.script.run
            .withSuccessHandler(data => {
                inventoryData = data;
                currentPage = 1;
                renderizarTabla();
            })
            .withFailureHandler(err => showCustomAlert('Error al buscar artículos: ' + err.message, 'error'))
            .buscarArticulosAvanzado(query, currentFilter);
    }

    function renderizarTabla() {
        const tableBody = document.getElementById('inventory-table-body');
        if(!tableBody) return;
        tableBody.innerHTML = '';

        if (!inventoryData || inventoryData.length === 0) {
            const msg = hasSearched ? 'No hay artículos que coincidan con los criterios.' : 'Escribe en el buscador y presiona Enter para comenzar.';
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-gray-500">${msg}</td></tr>`;
            return;
        }
        totalPages = Math.ceil(inventoryData.length / itemsPerPage);
        renderPage(currentPage);
    }

    function createRow(item) {
        const savedData = editedData[item.Clave] || {};
        const sistema = savedData.stockSistema !== undefined ? savedData.stockSistema : (item.StockSistema || 0);
        const stockFisico = savedData.stockFisico !== undefined ? savedData.stockFisico : '';
        const cpi = savedData.cpi !== undefined ? savedData.cpi : '';
        const vpe = savedData.vpe !== undefined ? savedData.vpe : '';
        const razon = savedData.razon !== undefined ? savedData.razon : '';
        const row = document.createElement('tr');
        row.className = 'tabular-nums transition-colors duration-200';
        row.dataset.clave = item.Clave;
        const razonOptions = RAZONES_AJUSTE.map(r => `<option value="${r}" ${r === razon ? 'selected' : ''}>${r}</option>`).join('');
        row.innerHTML = `
            <td class="p-4"><input type="checkbox" class="row-checkbox h-4 w-4 text-emerald-600 border-slate-500 rounded focus:ring-emerald-500"></td>
            <td class="px-4 py-3 text-gray-800"><div class="text-sm font-medium">${item.Descripcion || 'N/A'}</div><div class="text-xs text-slate-400">${item.Clave}</div></td>
            <td class="px-2 py-3 text-center"><input type="number" data-type="stockSistema" value="${sistema}" class="w-24 p-2 text-center bg-white border border-gray-300 rounded-md text-gray-800"></td>
            <td class="px-2 py-3 text-center"><input type="number" data-type="stockFisico" value="${stockFisico}" placeholder="0" class="w-24 p-2 text-center bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500 text-gray-800"></td>
            <td class="px-2 py-3 text-center"><input type="number" data-type="cpi" value="${cpi}" placeholder="0" class="w-24 p-2 text-center bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500 text-gray-800"></td>
            <td class="px-2 py-3 text-center"><input type="number" data-type="vpe" value="${vpe}" placeholder="0" class="w-24 p-2 text-center bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-emerald-500 text-gray-800"></td>
            <td class="px-4 py-3 w-48"><select data-type="razon" class="w-full p-2 border border-gray-300 rounded-md bg-white text-gray-800 focus:ring-emerald-500"><option value="">Seleccionar...</option>${razonOptions}</select></td>
            <td class="px-2 py-3 text-center"><span class="difference-value font-bold text-lg">0</span></td>
            <td class="px-2 py-3 text-center"><button class="reset-row-btn text-slate-500 hover:text-red-500" title="Resetear Fila"><span class="material-symbols-outlined">refresh</span></button></td>`;
        row.querySelectorAll('input[type="number"], select').forEach(el => el.addEventListener('input', () => manejarInputFila(row)));
        row.querySelector('.reset-row-btn').addEventListener('click', () => {
            delete editedData[item.Clave];
            row.replaceWith(createRow(item));
            actualizarVisibilidadAccionesLote();
        });
        actualizarColorInputs(row);
        if(stockFisico !== '') calcularYMostrarDiferencia(row);
        return row;
    }

    function renderPage(pageNumber) {
        currentPage = pageNumber;
        const tableBody = document.getElementById('inventory-table-body');
        const start = (pageNumber - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = inventoryData.slice(start, end);
        const rows = pageItems.map(item => createRow(item));
        tableBody.replaceChildren(...rows);
        document.getElementById('select-all-checkbox').addEventListener('change', toggleSelectAll);
        tableBody.querySelectorAll('.row-checkbox').forEach(cb => cb.addEventListener('change', actualizarVisibilidadAccionesLote));
        actualizarVisibilidadAccionesLote();
        const controls = document.getElementById('pagination-controls');
        controls.innerHTML = '';
        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'Anterior';
        prevBtn.className = 'px-3 py-1 border border-slate-600 rounded disabled:opacity-50 text-sm';
        prevBtn.disabled = pageNumber === 1;
        prevBtn.addEventListener('click', () => renderPage(currentPage - 1));
        controls.appendChild(prevBtn);

        const pageInfo = document.createElement('span');
        pageInfo.className = 'px-3 py-1 text-sm text-slate-400';
        pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
        controls.appendChild(pageInfo);

        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Siguiente';
        nextBtn.className = 'px-3 py-1 border border-slate-600 rounded disabled:opacity-50 text-sm';
        nextBtn.disabled = pageNumber === totalPages;
        nextBtn.addEventListener('click', () => renderPage(currentPage + 1));
        controls.appendChild(nextBtn);
    }

    function manejarInputFila(row) {
        const clave = row.dataset.clave;
        const valores = {
            clave: clave,
            descripcion: row.querySelector('.text-sm.font-medium').textContent,
            stockSistema: row.querySelector('input[data-type="stockSistema"]').value,
            stockFisico: row.querySelector('input[data-type="stockFisico"]').value,
            cpi: row.querySelector('input[data-type="cpi"]').value,
            vpe: row.querySelector('input[data-type="vpe"]').value,
            razon: row.querySelector('select[data-type="razon"]').value
        };
        if (Object.values(valores).some(v => v !== '' && v !== clave && v !== valores.descripcion)) {
            editedData[clave] = valores;
        } else {
            delete editedData[clave];
        }
        actualizarColorInputs(row);
        calcularYMostrarDiferencia(row);
    }

    function actualizarColorInputs(row) {
        row.querySelectorAll('input[data-type="stockFisico"], input[data-type="cpi"], input[data-type="vpe"], select[data-type="razon"]').forEach(el => {
            el.classList.toggle('text-gray-800', el.value && el.value !== '');
            el.classList.toggle('text-gray-500', !el.value || el.value === '');
        });
    }

    function calcularYMostrarDiferencia(row) {
        const sistema = parseFloat(row.querySelector('input[data-type="stockSistema"]').value) || 0;
        const fisico = parseFloat(row.querySelector('input[data-type="stockFisico"]').value) || 0;
        const cpi = parseFloat(row.querySelector('input[data-type="cpi"]').value) || 0;
        const vpe = parseFloat(row.querySelector('input[data-type="vpe"]').value) || 0;
        const diferencia = fisico - sistema - vpe - cpi;
        const diferenciaSpan = row.querySelector('.difference-value');
        diferenciaSpan.textContent = diferencia.toFixed(2);
        row.classList.remove('row-diff-positive', 'row-diff-negative');
        diferenciaSpan.classList.remove('diff-positive', 'diff-negative', 'diff-zero');
        if (diferencia > 0) {
            diferenciaSpan.classList.add('diff-positive'); row.classList.add('row-diff-positive');
        } else if (diferencia < 0) {
            diferenciaSpan.classList.add('diff-negative'); row.classList.add('row-diff-negative');
        } else {
            diferenciaSpan.classList.add('diff-zero');
        }
    }

    function registrarConteos() {
        const conteosValidos = Object.values(editedData).filter(d => d.stockFisico !== '');
        if (conteosValidos.length === 0) {
            showCustomAlert("Debes introducir el 'Stock Físico' para al menos un artículo antes de poder registrar.", 'info');
            return;
        }
        const summaryList = conteosValidos.map(item => `<li>${item.descripcion}</li>`).join('');
        showCustomConfirm(`Se van a registrar ajustes para <strong>${conteosValidos.length} artículos</strong>. ¿Deseas continuar?`, "Confirmar", "Cancelar")
            .then(confirmed => {
                if(confirmed) {
                    google.script.run
                        .withSuccessHandler(response => {
                            editedData = {};
                            showCustomAlert(response, 'success', () => {
                                forceCloseModal();
                                actualizarPuntajeYRanking();
                            });
                        })
                        .withFailureHandler(err => showCustomAlert(err.message, 'error'))
                        .registrarMultiplesConteos(conteosValidos, perfilActual.UsuarioID);
                }
            });
    }

    function cerrarModalDeConteo() {
        if (Object.keys(editedData).length > 0) {
            showCustomConfirm("Tienes conteos modificados que no se han registrado. Si cierras, perderás estos cambios.", "Cerrar sin guardar", "Continuar editando")
                .then(confirmed => { if(confirmed) forceCloseModal(); });
        } else {
            forceCloseModal();
        }
    }

    function forceCloseModal() {
        editedData = {}; inventoryData = []; hasSearched = false; currentPage = 1;
        modalContainer.classList.add('hidden');
        document.body.style.overflow = 'auto';
        modalContainer.innerHTML = '';
    }

    function handleSearch(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = e.target.value.trim();
            if (query === '') return;
            hasSearched = true;
            currentFilter = 'todos';
            actualizarBotonesFiltro();
            cargarYRenderizarInventario();
        }
    }

    function actualizarBotonesFiltro() {
        document.querySelectorAll('.inventory-filter-btn').forEach(btn => {
            const isSelected = btn.dataset.filter === currentFilter;
            btn.classList.toggle('bg-indigo-600', isSelected);
            btn.classList.toggle('text-white', isSelected);
            btn.classList.toggle('bg-gray-200', !isSelected);
            btn.classList.toggle('text-gray-700', !isSelected);
        });
    }

    function toggleSelectAll() {
        const isChecked = document.getElementById('select-all-checkbox').checked;
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = isChecked);
        actualizarVisibilidadAccionesLote();
    }

    function actualizarVisibilidadAccionesLote() {
        const anySelected = document.querySelectorAll('.row-checkbox:checked').length > 0;
        document.getElementById('batch-action-container').classList.toggle('hidden', !anySelected);
    }

    function aplicarRazonEnLote() {
        const reason = document.getElementById('batch-reason-select').value;
        if (!reason) return;
        document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
            const row = cb.closest('tr');
            row.querySelector('select[data-type="razon"]').value = reason;
            manejarInputFila(row);
        });
    }

    function imprimirTabla() {
        const printWindow = window.open('', '_blank');
        const rowsHtml = inventoryData.map(item => {
            const data = editedData[item.Clave] || {};
            const sistema = data.stockSistema !== undefined ? data.stockSistema : (item.StockSistema || 0);
            return `<tr><td>${item.Clave}</td><td>${item.Descripcion || ''}</td><td>${sistema}</td><td></td><td></td><td></td><td></td></tr>`;
        }).join('');
        printWindow.document.write(`<!DOCTYPE html><html><head><title>Hoja de Conteo</title><style>body{font-family:sans-serif}h1{font-size:16px}table{border-collapse:collapse;width:100%;font-size:12px}th,td{border:1px solid #000;padding:4px;text-align:left}th{background:#f0f0f0}</style></head><body><h1>Hoja de Conteo General</h1><table><thead><tr><th>Clave</th><th>Producto</th><th>Sistema</th><th>Físico</th><th>CPI</th><th>VPE</th><th>Razón</th></tr></thead><tbody>${rowsHtml}</tbody></table></body></html>`);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }
});
</script>
</body>
</html>
