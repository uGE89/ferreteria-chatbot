<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Conversacional Interna Version al 28-06-2025</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-track { background: #1e293b; }
        #chat-window::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .message-bubble { opacity: 0; transform: translateY(20px); animation: slide-up 0.4s ease-out forwards; }
        @keyframes slide-up { to { opacity: 1; transform: translateY(0); } }
        .typing-dot { width: 8px; height: 8px; background-color: #94a3b8; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .quick-starter-btn { background-color: transparent; border: 1px solid #475569; color: #94a3b8; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out; }
        .quick-starter-btn:hover { background-color: #1e293b; color: #e2e8f0; border-color: #64748b; }
        .suggestion-item {
            background-color: #334155; /* bg-slate-700 */
            border: 1px solid #475569; /* border-slate-600 */
            color: #e2e8f0; /* text-slate-200 */
            padding: 8px 12px;
            margin-top: 4px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            width: 100%;
            transition: background-color 0.2s;
        }
        .suggestion-item:hover {
            background-color: #475569; /* bg-slate-600 */
        }
        /* ESTILOS AÑADIDOS PARA LOS BOTONES DEL FILTRO DE ADMIN */
        .admin-tab-btn {
            padding: 6px 12px;
            border-radius: 9999px; /* Para hacerlos pill-shaped */
            background-color: #334155; /* bg-slate-700 */
            color: #e2e8f0; /* text-slate-200 */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none; /* Asegura que no tengan borde por defecto */
        }
        .admin-tab-btn:hover {
            background-color: #475569; /* bg-slate-600 */
        }
        .admin-tab-btn.bg-yellow-500 { /* Clase para el botón activo */
            background-color: #f59e0b; /* bg-yellow-500 */
            color: #000; /* text-black */
            font-weight: bold;
        }

        /* Estilos para los botones de navegación móvil */
        .mobile-nav-btn {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            background-color: #334155; /* bg-slate-700 */
            border: 1px solid #475569; /* border-slate-600 */
            color: #94a3b8; /* text-slate-400 */
            transition: all 0.2s ease-in-out;
        }
        .mobile-nav-btn.active {
            background-color: #f59e0b; /* bg-amber-500 */
            color: #1e293b; /* text-slate-800 */
            border-color: #f59e0b;
        }

        .row-diff-positive { background-color: #f0fdf4; }
        .row-diff-negative { background-color: #fef2f2; }
        .row-diff-positive:hover { background-color: #dcfce7; }
        .row-diff-negative:hover { background-color: #fee2e2; }
        .diff-positive { color: #15803d; }
        .diff-negative { color: #b91c1c; }
        .diff-zero { color: #475569; }

/* ... otras reglas ... */


    </style>
</head>
<body class="bg-slate-900 text-slate-200 flex justify-center items-center min-h-screen">

<div id="login-card" class="w-full max-w-sm">
    <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl text-center">
        <h1 class="text-2xl mb-2 font-bold">Acceso a Plataforma</h1>
        <p class="text-slate-400 mb-6 text-sm">Ferretería Flores</p>
        <div class="mb-4">
            <input id="inputID" type="text" placeholder="Ingresa tu ID (ej. U001)"
                   class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-center" />
        </div>
        <div class="mb-4">
            <input id="inputPIN" type="password" placeholder="Ingresa tu PIN"
                   class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 text-center" />
        </div>
        <button id="btnLogin" class="w-full bg-emerald-500 hover:bg-emerald-600 px-6 py-2.5 rounded-lg text-white font-semibold transition duration-300 disabled:bg-slate-600">
            Entrar
        </button>
        <p id="loginMsg" class="mt-4 text-red-400 text-xs h-4"></p>
    </div>
</div>

<div id="app-container" class="w-full max-w-7xl h-[90vh] max-h-[900px] flex-col gap-4 hidden bg-slate-900 rounded-2xl shadow-2xl p-4">
    <header class="flex justify-between items-center flex-shrink-0">
        <div>
            <h1 id="header-title" class="text-lg font-bold text-white">Plataforma Conversacional Interna V280625</h1>
            <p id="header-subtitle" class="text-xs text-slate-400">Ferretería Flores</p>
        </div>
        <div class="flex items-center space-x-4">
            <div id="user-info-area" class="text-right">
                <p id="user-status" class="text-sm font-medium text-emerald-400">Conectando...</p>
                <p id="user-id-display" class="text-xs text-slate-400 font-mono"></p>
            </div>
            <div id="admin-view-switcher" class="flex items-center p-1 bg-slate-700 rounded-lg hidden">
                <button id="showChatBtn" class="px-3 py-1 rounded-md text-xs font-semibold">
                    Chat
                </button>
                <button id="showAdminPanelBtn" class="px-3 py-1 rounded-md text-xs font-semibold">
                    Panel
                </button>
            </div>
            <button id="logoutBtn" class="px-3 py-1 rounded text-xs text-slate-400 border border-slate-600 hover:text-red-400 hover:border-red-400 transition">
                Cerrar sesión
            </button>
        </div>
    </header>

    <div id="content-area" class="flex-1 w-full flex overflow-hidden">
        <div id="chat-column" class="flex flex-col h-full w-full bg-slate-800 rounded-xl overflow-hidden">
            <main id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-6" aria-live="polite">
                </main>
            <div id="quick-starters" class="p-4 border-t border-slate-700 flex-shrink-0">
                <p class="text-xs text-slate-400 mb-2 font-semibold">Iniciadores rápidos:</p>
                <div class="flex flex-wrap gap-2"></div>
            </div>
            <div id="suggestions-container" class="px-4 pb-2"></div>
            <footer class="p-4 border-t border-slate-700 flex-shrink-0">
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="text" id="message-input" placeholder="Escribe tu mensaje o reporte aquí..." class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-sm text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                    <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg p-2.5 transition disabled:bg-slate-600 flex items-center justify-center" aria-label="Enviar Mensaje">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
            </footer>
        </div>

        <div id="admin-panel" class="hidden flex-col h-full w-full bg-slate-800 rounded-xl overflow-y-auto">
             </div>
    </div>
</div>


    <div id="modal-container" class="fixed inset-0 bg-slate-900 bg-opacity-75 hidden flex justify-center items-center p-4 z-50">
    </div>

    <div id="custom-alert-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 hidden justify-center items-center p-4 z-[100]">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h3 id="custom-alert-title" class="text-xl font-bold mb-4 text-white"></h3>
            <p id="custom-alert-message" class="text-slate-300 mb-6"></p>
            <button id="custom-alert-close-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg">
                Aceptar
            </button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="fixed inset-0 bg-slate-900 bg-opacity-75 hidden justify-center items-center p-4 z-[100]">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h3 id="custom-confirm-title" class="text-xl font-bold mb-4 text-white">Confirmación</h3>
            <p id="custom-confirm-message" class="text-slate-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="custom-confirm-yes-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-lg">
                    Sí
                </button>
                <button id="custom-confirm-no-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg">
                    No
                </button>
            </div>
        </div>
    </div>
<script>
    // =========================================================================
    // ================ SCRIPT FINAL Y UNIFICADO PARA INDEX.HTML ===============
    // =========================================================================

    // --- Frontend Elements ---
// --- Frontend Elements (NUEVA ESTRUCTURA) ---
const loginCard = document.getElementById('login-card');
const appContainer = document.getElementById('app-container'); // Contenedor principal
const btnLogin = document.getElementById('btnLogin');
const inputID = document.getElementById('inputID');
const loginMsg = document.getElementById('loginMsg');

// Elementos de la cabecera
const userStatus = document.getElementById('user-status');
const userIdDisplay = document.getElementById('user-id-display');
const logoutBtn = document.getElementById('logoutBtn');
const adminViewSwitcher = document.getElementById('admin-view-switcher');
const showChatBtn = document.getElementById('showChatBtn');
const showAdminPanelBtn = document.getElementById('showAdminPanelBtn');

// Paneles de contenido
const chatColumn = document.getElementById('chat-column');
const adminPanel = document.getElementById('admin-panel');

// Elementos del chat (la mayoría se mantienen)
const chatWindow = document.getElementById('chat-window');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const quickStartersContainer = document.getElementById('quick-starters').querySelector('div');
const suggestionsContainer = document.getElementById('suggestions-container');

    // --- Global State Variables ---
    let perfilActual = null;
    let currentModalEnteredCounts = {};
    let adminState = { // New admin state
        items: [],
        filters: {
            tipo: 'Todos',
            fecha: ''
        }
    };

    // --- Custom Alert/Confirm Functions ---
    function showCustomAlert(message, type = 'info', onClose) {
        const alertModal = document.getElementById('custom-alert-modal');
        const alertMessage = document.getElementById('custom-alert-message');
        const alertTitle = document.getElementById('custom-alert-title');
        const alertCloseBtn = document.getElementById('custom-alert-close-btn');

        alertMessage.textContent = message;
        alertModal.classList.remove('hidden', 'bg-red-900/75', 'bg-emerald-900/75', 'bg-blue-900/75', 'bg-slate-900/75');
        alertModal.classList.add('flex');

        let title = '';
        switch (type) {
            case 'success':
                alertModal.classList.add('bg-emerald-900/75');
                title = 'Éxito';
                break;
            case 'error':
                alertModal.classList.add('bg-red-900/75');
                title = 'Error';
                break;
            default: // info
                alertModal.classList.add('bg-slate-900/75');
                title = 'Información';
                break;
        }
        alertTitle.textContent = title;

        alertCloseBtn.onclick = () => {
            alertModal.classList.add('hidden');
            if (typeof onClose === 'function') onClose();
        };
    }

    function showCustomConfirm(message, yesText = 'Sí', noText = 'No', title = 'Confirmación') {
        return new Promise((resolve) => {
            const confirmModal = document.getElementById('custom-confirm-modal');
            const confirmMessage = document.getElementById('custom-confirm-message');
            const confirmTitle = document.getElementById('custom-confirm-title');
            const confirmYesBtn = document.getElementById('custom-confirm-yes-btn');
            const confirmNoBtn = document.getElementById('custom-confirm-no-btn');

            confirmMessage.innerHTML = message;
            if (confirmTitle) confirmTitle.textContent = title;
            confirmYesBtn.textContent = yesText;
            confirmNoBtn.textContent = noText;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');

            const closeConfirm = (result) => {
                confirmModal.classList.add('hidden');
                resolve(result);
            };

            confirmYesBtn.onclick = () => closeConfirm(true);
            confirmNoBtn.onclick = () => closeConfirm(false);
        });
    }

    // --- LOGOUT BUTTON ---
    logoutBtn.addEventListener('click', async () => {
        const confirmed = await showCustomConfirm("¿Seguro que querés cerrar sesión?");
        if (!confirmed) return;
        sessionStorage.clear();
        location.reload();
    });

    // --- LÓGICA DE LOGIN E INICIALIZACIÓN (Modificado y unificado) ---

    // Este listener document.addEventListener('DOMContentLoaded') ahora gestiona el auto-login
    document.addEventListener('DOMContentLoaded', () => {
        const storedProfile = sessionStorage.getItem('perfil');
        if (storedProfile) {
            // Si hay un perfil guardado, rellena el ID y simula un clic en el botón de login
            inputID.value = JSON.parse(storedProfile).UsuarioID;
            // No llamar directamente a procesarDatosIniciales aquí
            // para que pase por el flujo normal de validación del login.
            btnLogin.click();
        } else {
            console.log("No hay sesión almacenada, mostrando pantalla de login.");
        }
    });

    // Listener para el botón de login
// Dentro de tu etiqueta <script> en index.html

btnLogin.addEventListener('click', () => {
    const id = document.getElementById('inputID').value.trim();
    const pin = document.getElementById('inputPIN').value.trim();

    if (!id || !pin) {
        // En lugar de usar loginMsg, usamos el modal de alerta que ya tienes
        showCustomAlert("Por favor, ingresa tu ID y tu PIN.", 'info');
        return;
    }

    loginMsg.textContent = "Validando...";
    btnLogin.disabled = true;

    // La función que llama al backend ahora debe enviar ambos argumentos
    google.script.run
        .withSuccessHandler(procesarDatosIniciales)
        // Asumo que tienes una función para mostrar errores, si no, puedes usar showCustomAlert
        .withFailureHandler(err => {
            showCustomAlert(`Error de Login: ${err.message}`, 'error');
            btnLogin.disabled = false;
            loginMsg.textContent = '';
        })
        .cargarDatosIniciales(id, pin);
});


    // Función principal que procesa los datos iniciales después del login exitoso
    // MODIFICACIÓN DE LA FUNCIÓN procesarDatosIniciales
function procesarDatosIniciales(datos) {
    console.log("📦 datos recibidos del Apps Script:", datos);
    if (!datos.ok) {
        loginMsg.textContent = datos.msg;
        btnLogin.disabled = false;
        return;
    }

    // Guardar estado
    sessionStorage.setItem('perfil', JSON.stringify(datos.perfil));
    sessionStorage.setItem('sessionId', datos.sesionId);
    perfilActual = datos.perfil;

    // --- NUEVA LÓGICA DE UI ---
    loginCard.classList.add('hidden');
    appContainer.classList.remove('hidden');
    appContainer.classList.add('flex'); // Aseguramos que sea flex

    // Renderizar Header
    userStatus.textContent = `Activo: ${perfilActual.Nombre}`;
    userIdDisplay.textContent = `Sucursal: ${perfilActual.Sucursal} | Rol: ${perfilActual.Rol}`;

    // Renderizar Chat
    renderizarChatInicial(datos.mensajeAnuncio, datos.quickStarters);

    // --- LÓGICA DE VISIBILIDAD PARA ADMIN ---
    if (perfilActual.Rol === "Administrador") {
        adminViewSwitcher.classList.remove('hidden');
        showChatBtn.addEventListener('click', () => updateActiveView('chat'));
        showAdminPanelBtn.addEventListener('click', () => updateActiveView('admin'));
        updateActiveView('chat'); // Vista inicial por defecto

        // Inicializar el contenido del panel de admin (tu función original)
        renderAdminPanel();
        refrescarPanelAdmin();

    } else {
        adminViewSwitcher.classList.add('hidden');
        updateActiveView('chat'); // Los no-admin solo ven el chat
        adminPanel.remove(); // Opcional: eliminar el panel si no es admin
    }

    // Habilitar inputs del chat
    messageInput.disabled = false;
    messageInput.focus();
    sendButton.disabled = false;
}

    // --- LÓGICA DE CHAT: Funciones para renderizar mensajes y manejar la IA ---

    // Esta función reemplaza a 'initializeChat' y se encarga de mostrar la info del usuario
    function renderizarHeader(perfil) {
        const userStatus = document.getElementById('user-status');
        const userIdDisplay = document.getElementById('user-id-display');

        userStatus.textContent = `Activo: ${perfil.Nombre}`;
        userIdDisplay.textContent = `Sucursal: ${perfil.Sucursal} | Rol: ${perfil.Rol}`;
    }

    // Esta función reemplaza la lógica de bienvenida y quick starters que estaba en 'procesarDatosIniciales'
    function renderizarChatInicial(mensajeAnuncio, quickStarters) {
        if (mensajeAnuncio && Array.isArray(mensajeAnuncio)) {
            let delay = 500;
            mensajeAnuncio.forEach(mensaje => {
                setTimeout(() => {
                    addMessage(mensaje, 'system');
                }, delay);
                delay += 1200;
            });
        }
        if (quickStarters && Array.isArray(quickStarters)) {
            renderQuickStarters(quickStarters);
        }
    }

    function addMessage(text, sender) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `flex message-bubble ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

        let bubbleClasses = 'max-w-md lg:max-w-xl rounded-2xl px-4 py-2.5 text-sm shadow-md ';
        let bubbleContent = '';

        switch (sender) {
            case 'user':
                bubbleClasses += 'bg-blue-600 text-white rounded-br-lg';
                bubbleContent = `<p>${text}</p>`;
                break;
            case 'ai':
                bubbleClasses += 'bg-slate-700 text-slate-200 rounded-bl-lg';
                bubbleContent = `<p>${text}</p>`;
                break;
            case 'system':
                bubbleClasses += 'bg-yellow-900/50 border border-yellow-600/50 text-yellow-300 w-full rounded-lg';
                bubbleContent = `<div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><p class="font-mono text-xs">${text}</p></div>`;
                break;
        }

        messageContainer.innerHTML = `<div class="${bubbleClasses}">${bubbleContent}</div>`;
        chatWindow.appendChild(messageContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showTypingIndicator() {
        if (document.getElementById('typing-indicator')) return;
        const typingIndicator = document.createElement('div');
        typingIndicator.id = 'typing-indicator';
        typingIndicator.className = 'flex justify-start message-bubble';
        typingIndicator.innerHTML = `<div class="bg-slate-700 text-slate-200 rounded-2xl rounded-bl-lg px-4 py-2.5 shadow-md"><div class="flex items-center gap-1.5"><span class="typing-dot"></span><span class="typing-dot" style="animation-delay: 0.2s;"></span><span class="typing-dot" style="animation-delay: 0.4s;"></span></div></div>`;
        chatWindow.appendChild(typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    function getAIResponse(payload) {
        messageInput.disabled = true;
        sendButton.disabled = true;
        showTypingIndicator();

        const userIdToPass = perfilActual?.UsuarioID;
        const sessionIdToPass = sessionStorage.getItem('sessionId');

        if (!userIdToPass || !sessionIdToPass) {
            hideTypingIndicator();
            showCustomAlert("⚠️ La sesión de usuario no está activa o se ha perdido. Por favor, intentá cerrar sesión y volver a entrar.", 'error');
            messageInput.disabled = false;
            sendButton.disabled = false;
            return;
        }

        google.script.run
            .withSuccessHandler(handleAIResponse)
            .withFailureHandler(handleAIError)
            .enviarAOpenAI(sessionIdToPass, userIdToPass, payload);
    }

    function handleAIResponse(data) {
        hideTypingIndicator();

        if (data.content) {
            addMessage(data.content, 'ai');
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }

        // --- NEW LOGIC TO HANDLE TOOLS ---
        if (data.tool_call) {
            const toolCall = data.tool_call;
            const functionName = toolCall.function.name;
            const functionArgs = JSON.parse(toolCall.function.arguments);

            addMessage(`Ejecutando: ${functionName}...`, 'system');

            const userId = perfilActual.UsuarioID;
            const sessionId = sessionStorage.getItem('sessionId');

            google.script.run
                .withSuccessHandler(functionResult => {
                    addMessage(`Resultado: ${functionResult}`, 'system');

                    const payloadForNextStep = {
                        texto: null,
                        tool_response: {
                            tool_call_id: toolCall.id,
                            function_name: functionName,
                            result: functionResult
                        }
                    };

                    showTypingIndicator();
                    google.script.run
                        .withSuccessHandler(handleAIResponse)
                        .withFailureHandler(handleAIError)
                        .enviarAOpenAI(sessionId, userId, payloadForNextStep);
                })
                .withFailureHandler(handleAIError)
                .ejecutarHerramienta(functionName, functionArgs, userId, sessionId);
        } else {
            // If it's not a function call, make sure inputs are enabled
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }
    }

    function handleAIError(error) {
        hideTypingIndicator();
        showCustomAlert(`Ocurrió un error al procesar tu solicitud: ${error.message}.`, 'error');
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    }

    // --- Lógica del Panel de Administración (NUEVAS FUNCIONES) ---

    function renderAdminPanel() {
        const container = document.getElementById('admin-panel');
        if (!container) return;

        // 1. Dibuja la estructura y los filtros
        container.innerHTML = `
            <div class="p-4 sticky top-0 bg-slate-800 border-b border-slate-700 z-10">
                <h2 class="text-lg font-bold text-white mb-4">Panel de Administración</h2>
                <div id="admin-filter-tabs" class="flex gap-2 flex-wrap text-sm mb-3">
                  <button data-tipo="Todos" class="admin-tab-btn bg-yellow-500 text-black font-bold">Todos</button>
                  <button data-tipo="Problema" class="admin-tab-btn">⚠️ Problemas</button>
                  <button data-tipo="Sugerencia" class="admin-tab-btn">💡 Sugerencias</button>
                  <button data-tipo="Tarea" class="admin-tab-btn">📝 Tareas</button>
                  <button data-tipo="Caja" class="admin-tab-btn">💰 Caja</button>
                </div>
                <input type="date" id="admin-filter-fecha" class="w-full bg-slate-700 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-3">
                 <button onclick="google.script.run.withSuccessHandler(resumen => showCustomAlert(resumen, 'info')).withFailureHandler(error => showCustomAlert('Error al cargar resumen: ' + error.message, 'error')).generarResumenAdmin();" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg px-4 py-1.5 text-sm">
                    Generar Resumen Diario
                </button>
            </div>
            <div id="admin-items-container" class="p-4 space-y-3"></div>
        `;

        // Set initial filter values if they exist in adminState
        const initialActiveButton = document.querySelector(`.admin-tab-btn[data-tipo="${adminState.filters.tipo}"]`);
        if (initialActiveButton) {
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('bg-yellow-500', 'text-black', 'font-bold'));
            initialActiveButton.classList.add('bg-yellow-500', 'text-black', 'font-bold');
        }
        document.getElementById('admin-filter-fecha').value = adminState.filters.fecha;

        renderFilteredAdminItems(); // Renderiza los ítems inicialmente

        // Listener para los nuevos botones de tipo (usando addEventListener)
        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                adminState.filters.tipo = btn.dataset.tipo;
                document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('bg-yellow-500', 'text-black', 'font-bold'));
                btn.classList.add('bg-yellow-500', 'text-black', 'font-bold');
                renderFilteredAdminItems();
            });
        });

        // Listener para el input de fecha (usando addEventListener)
        document.getElementById('admin-filter-fecha').addEventListener('change', (e) => {
            adminState.filters.fecha = e.target.value;
            renderFilteredAdminItems();
        });
    }

    function renderFilteredAdminItems() {
        const container = document.getElementById('admin-items-container');
        if (!container) return;

        let itemsToShow = [...adminState.items];

        if (adminState.filters.tipo !== 'Todos') {
            itemsToShow = itemsToShow.filter(item => item.tipo === adminState.filters.tipo);
        }

        if (adminState.filters.fecha) {
            itemsToShow = itemsToShow.filter(item => {
                const itemDate = item.fecha instanceof Date && !isNaN(item.fecha) ? item.fecha :
                                 (typeof item.fecha === 'string' ? new Date(item.fecha) : null);

                if (itemDate && !isNaN(itemDate.getTime())) {
                    const filterDate = new Date(adminState.filters.fecha);
                    return itemDate.getFullYear() === filterDate.getFullYear() &&
                           itemDate.getMonth() === filterDate.getMonth() &&
                           itemDate.getDate() === filterDate.getDate();
                }
                return false;
            });
        }

        if (itemsToShow.length === 0) {
            container.innerHTML = '<p class="text-slate-400 text-center text-sm p-4">No hay ítems que coincidan.</p>';
            return;
        }

        // 1. Creamos el HTML como antes
        container.innerHTML = itemsToShow.map(item => {
            const statusColor = item.estado === 'Pendiente' ? 'bg-yellow-500/20 text-yellow-300' : 'bg-green-500/20 text-green-300';
            const tipoIcono = { Problema: '⚠️', Sugerencia: '💡', Tarea: '📝', Caja: '💰' }[item.tipo] || '📁';
            const fechaFormateada = item.fecha && item.fecha instanceof Date && !isNaN(item.fecha.getTime()) ?
                                     item.fecha.toLocaleDateString('es-NI') : 'Sin fecha';

            return `
                <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-white text-sm pr-2">${tipoIcono} ${item.asunto || 'Sin asunto'}</p>
                        <span class="text-xs ${statusColor} px-2 py-0.5 rounded-full whitespace-nowrap">${item.estado}</span>
                    </div>
                    <p class="text-xs text-slate-400 mt-1 mb-2 break-words">${item.detalle || ''}</p>
                    <div class="flex justify-between items-center text-xs text-slate-500">
                        <span>${item.usuario || 'N/A'} - ${fechaFormateada}</span>
                        ${item.estado === 'Pendiente' ?
                            `<button data-item-id="${item.id}" class="btn-marcar-revisado px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs">Marcar Revisado</button>` : ''
                        }
                    </div>
                </div>
            `;
        }).join('');

        // --- 2. AÑADIMOS LOS LISTENERS DESPUÉS DE CREAR EL HTML ---
        container.querySelectorAll('.btn-marcar-revisado').forEach(btn => {
            btn.addEventListener('click', () => {
                const itemId = btn.dataset.itemId;
                solicitarCambioEstado(itemId, 'Revisado');
            });
        });
    }

    function solicitarCambioEstado(itemId, nuevoEstado) {
        if (!confirm(`¿Seguro que quieres cambiar el estado a "${nuevoEstado}"?`)) return;

        google.script.run
            .withSuccessHandler(response => {
                showCustomAlert(response, 'success');
                // Para refrescar la lista, simplemente llamamos a nuestra nueva función central.
                refrescarPanelAdmin(); // <-- Llamada a la nueva función de refresco
            })
            .withFailureHandler(err => showCustomAlert(err.message, 'error'))
            .actualizarEstadoItemAdmin(itemId, nuevoEstado);
    }

    // --- CHAT EVENTS ---
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const userInput = messageInput.value.trim();
        if (userInput) {
            addMessage(userInput, 'user');
            getAIResponse({ texto: userInput, claveProducto: null });
            messageInput.value = '';
        }
    });





quickStartersContainer.addEventListener('click', (e) => {
    // Nos aseguramos de que el clic fue en un botón de inicio rápido
    if (e.target.tagName === 'BUTTON' && e.target.classList.contains('quick-starter-btn')) {
        
        // Obtenemos el nombre de la función que guardamos en el atributo 'data-function-name' del botón
        const functionName = e.target.dataset.functionName;
        const buttonText = e.target.textContent;

        // ==========================================================
        // ==== ¡NUEVA LÓGICA INTELIGENTE! ====
        // ==========================================================
        
        // Comprobamos si el botón presionado es el de registrar conteo
        if (functionName === 'registrarConteo') {
            
            // Si es el de conteo, llamamos directamente a la función que abre el modal
            console.log("Botón de conteo detectado. Abriendo modal directamente.");
            abrirModalDeConteo();
            
        } else {
            
            // Si es cualquier otro botón, mantenemos el comportamiento original:
            // Lo enviamos como un mensaje al chat para que la IA lo procese.
            console.log(`Botón regular detectado: "${buttonText}". Enviando al chat.`);
            addMessage(buttonText, 'user');
            getAIResponse({ texto: buttonText });
            messageInput.value = '';
            messageInput.focus();
        }
    }
});



function renderQuickStarters(starters) {
    quickStartersContainer.innerHTML = '';
    if (!starters || starters.length === 0) return;

    const buttonClasses = 'quick-starter-btn bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-full text-sm transition duration-200 ease-in-out';

    starters.forEach(starterObject => {
        const button = document.createElement('button');
        button.className = buttonClasses;
        button.textContent = starterObject.NombrePantalla;
        button.dataset.functionName = starterObject.NombreFuncion;

        // Si el iniciador corresponde a "registrarConteo" asignamos un id
        // específico para poder referenciarlo desde otros scripts.
        if (starterObject.NombreFuncion === 'registrarConteo') {
            button.id = 'abrirModalConteoBtn';
        }

        quickStartersContainer.appendChild(button);
    });
}

    // --- LÓGICA DEL BUSCADOR @ ---
    messageInput.addEventListener('input', () => {
        const text = messageInput.value;
        const atIndex = text.lastIndexOf('@');

        if (atIndex !== -1) {
            const query = text.substring(atIndex + 1);
            if (query.length >= 2) {
                google.script.run
                    .withSuccessHandler(displaySuggestions)
                    .buscarArticulo(query);
            } else {
                suggestionsContainer.innerHTML = '';
            }
        } else {
            suggestionsContainer.innerHTML = '';
        }
    });

    function displaySuggestions(suggestions) {
        suggestionsContainer.innerHTML = '';
        if (suggestions && suggestions.length > 0) {
            suggestions.forEach(suggestion => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'suggestion-item';
                item.textContent = suggestion;
                item.onclick = () => {
                    selectSuggestion(suggestion);
                };
                suggestionsContainer.appendChild(item);
            });
        }
    }

    function selectSuggestion(suggestion) {
        const text = messageInput.value;
        const atIndex = text.lastIndexOf('@');
        const newText = text.substring(0, atIndex) + suggestion + ' ';
        messageInput.value = newText;
        suggestionsContainer.innerHTML = '';
        messageInput.focus();
    }

    // --- LÓGICA DEL MODAL (Conteo de Inventario) ---

// --- INICIO DE LA LÓGICA DEL MODAL DE CONTEO ---
document.addEventListener('DOMContentLoaded', () => {

    // --- VARIABLES Y REFERENCIAS DOM DEL MODAL ---
    // Asegúrate de que el botón que abre tu modal tenga el id 'abrirModalConteoBtn' o ajústalo aquí.
    const openModalBtn = document.getElementById('abrirModalConteoBtn'); 
    // Usamos #modal-container como overlay y contenedor del contenido
    const modalOverlay = document.getElementById('modal-container');
    const modalContainer = modalOverlay; // El div que cargará el HTML del modal
    
    // Variables globales para el estado del modal
    let editedData = {};
    let inventoryData = []; // Caché de los datos del inventario cargados
    let currentFilter = 'hoy';
    let hasSearched = false; // Controla si el usuario ya realizó una búsqueda
    const RAZONES_AJUSTE = ["Entrega incorrecta", "Recepción incorrecta", "Devolución de cliente", "Devolución de proveedor", "Ajuste de inventario", "Merma", "Otro"];

    const itemsPerPage = 20;
    let currentPage = 1;
    let totalPages = 1;

    // --- LÓGICA PRINCIPAL ---
    
    // Función para abrir y preparar el modal
    function abrirModalDeConteo() {
        showSpinner(true);
        google.script.run
            .withSuccessHandler(html => {
                modalContainer.innerHTML = html;
                modalOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Evita scroll de fondo

                // Una vez cargado el HTML, inicializamos todos los listeners y funciones
                inicializarModal();
                showSpinner(false);
            })
            .withFailureHandler(err => {
                alert('Error al cargar el modal: ' + err.message);
                showSpinner(false);
            })
            .abrirModalDeConteo();
    }
    // Exponer la función para que pueda usarse fuera de este alcance
    window.abrirModalDeConteo = abrirModalDeConteo;

    // Función que se ejecuta una vez que el HTML del modal está en la página
    function inicializarModal() {
        const confirmContainer = document.getElementById('confirmation-modal-container');
        if (confirmContainer && !document.getElementById('confirmation-title')) {
            confirmContainer.innerHTML = `
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
                    <h3 id="confirmation-title" class="text-xl font-bold mb-4 text-white"></h3>
                    <div id="confirmation-body" class="text-slate-300 mb-6"></div>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-btn-primary" class="px-4 py-2 text-white rounded-md bg-blue-600 hover:bg-blue-700"></button>
                        <button id="confirm-btn-secondary" class="px-4 py-2 text-white rounded-md bg-slate-600 hover:bg-slate-700">Cancelar</button>
                    </div>
                </div>`;
        }
        // Listeners para botones principales
        document.getElementById('close-modal-button').addEventListener('click', cerrarModalDeConteo);
        document.getElementById('print-list-button').addEventListener('click', imprimirTabla);
        document.getElementById('register-counts-button').addEventListener('click', registrarConteos);
        document.getElementById('search-inventory-input').addEventListener('keydown', handleSearch);

        // Listeners para filtros
        document.querySelectorAll('.inventory-filter-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                currentFilter = e.target.dataset.filter;
                document.getElementById('search-inventory-input').value = '';
                hasSearched = true; // asegurar mensaje correcto cuando no haya resultados
                actualizarBotonesFiltro();
                cargarYRenderizarInventario();
            });
        });
        
        // Listener para acciones en lote
        document.getElementById('apply-batch-reason-btn').addEventListener('click', aplicarRazonEnLote);

        // Llenar el select de razones en lote
        const batchReasonSelect = document.getElementById('batch-reason-select');
        batchReasonSelect.innerHTML = `<option value="">Seleccionar...</option>` + RAZONES_AJUSTE.map(r => `<option value="${r}">${r}</option>`).join('');

        // Estado inicial
        hasSearched = false;
        inventoryData = [];
        renderizarTabla();
    }

    // Carga los datos del backend y los muestra
    function cargarYRenderizarInventario() {
        const query = document.getElementById('search-inventory-input').value;
        showTableSpinner(true);
        
        google.script.run
            .withSuccessHandler(data => {
                inventoryData = data;
                currentPage = 1;
                renderizarTabla();
                showTableSpinner(false);
            })
            .withFailureHandler(err => {
                alert('Error al buscar artículos: ' + err.message);
                showTableSpinner(false);
            })
            .buscarArticulosAvanzado(query, currentFilter); // Pasamos el filtro al backend
    }

    // Renderiza la tabla con los datos actuales
    function renderizarTabla() {
        const tableBody = document.getElementById('inventory-table-body');
        tableBody.innerHTML = '';

        if (!inventoryData || inventoryData.length === 0) {
            const msg = hasSearched
                ? 'No hay artículos que coincidan con los criterios.'
                : 'Escribe en el buscador y presiona Enter para comenzar.';
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-gray-500">${msg}</td></tr>`;
            return;
        }

        totalPages = Math.ceil(inventoryData.length / itemsPerPage);
        renderPage(currentPage);
    }

    function renderPage(pageNumber) {
        currentPage = pageNumber;

        const tableBody = document.getElementById('inventory-table-body');
        tableBody.innerHTML = '';

        const start = (pageNumber - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = inventoryData.slice(start, end);

        pageItems.forEach(item => {
            const savedData = editedData[item.Clave] || {};
            const sistema = savedData.stockSistema !== undefined ? savedData.stockSistema : (item.StockSistema || 0);
            const stockFisico = savedData.stockFisico !== undefined ? savedData.stockFisico : '';
            const cpi = savedData.cpi !== undefined ? savedData.cpi : '';
            const vpe = savedData.vpe !== undefined ? savedData.vpe : '';
            const razon = savedData.razon !== undefined ? savedData.razon : '';

            const row = document.createElement('tr');
            row.className = 'tabular-nums transition-colors duration-200';
            row.dataset.clave = item.Clave;

            const razonOptions = RAZONES_AJUSTE.map(r => `<option value="${r}" ${r === razon ? 'selected' : ''}>${r}</option>`).join('');

            row.innerHTML = `
                <td class="p-4"><input type="checkbox" class="row-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded"></td>
                <td class="px-4 py-3">
                    <div class="text-sm font-medium text-gray-900">${item.Descripcion || 'N/A'}</div>
                    <div class="text-xs text-gray-500">${item.Clave}</div>
                </td>
                <td class="px-2 py-3 text-center"><input type="number" data-type="stockSistema" value="${sistema}" class="w-24 p-2 text-center bg-gray-100 border border-gray-300 rounded-md text-gray-900"></td>
                <td class="px-2 py-3 text-center"><input type="number" data-type="stockFisico" value="${stockFisico}" placeholder="0" class="w-24 p-2 text-center border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 text-gray-500"></td>
                <td class="px-2 py-3 text-center"><input type="number" data-type="cpi" value="${cpi}" placeholder="0" class="w-24 p-2 text-center border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 text-gray-500"></td>
                <td class="px-2 py-3 text-center"><input type="number" data-type="vpe" value="${vpe}" placeholder="0" class="w-24 p-2 text-center border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 text-gray-500"></td>
                <td class="px-4 py-3 w-48"><select data-type="razon" class="w-full p-2 border border-gray-300 rounded-md bg-white text-gray-500"><option value="">Seleccionar...</option>${razonOptions}</select></td>
                <td class="px-2 py-3 text-center"><span class="difference-value font-bold text-lg">0</span></td>
                <td class="px-2 py-3 text-center"><button class="reset-row-btn text-gray-400 hover:text-red-600" title="Resetear Fila"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg></button></td>
            `;
            tableBody.appendChild(row);

            row.querySelectorAll('input[type="number"], select').forEach(el => el.addEventListener('input', () => manejarInputFila(row)));
            row.querySelector('.reset-row-btn').addEventListener('click', () => {
                delete editedData[item.Clave];
                renderPage(currentPage);
            });

            actualizarColorInputs(row);
            if(stockFisico !== '') calcularYMostrarDiferencia(row);
        });

        document.getElementById('select-all-checkbox').addEventListener('change', toggleSelectAll);
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.addEventListener('change', actualizarVisibilidadAccionesLote));
        actualizarVisibilidadAccionesLote();

        const controls = document.getElementById('pagination-controls');
        controls.innerHTML = '';

        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'Prev';
        prevBtn.className = 'px-2 py-1 border rounded';
        prevBtn.disabled = pageNumber === 1;
        prevBtn.addEventListener('click', () => renderPage(currentPage - 1));
        controls.appendChild(prevBtn);

        for(let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.className = 'px-2 py-1 border rounded' + (i === currentPage ? ' bg-indigo-600 text-white' : '');
            pageBtn.disabled = i === currentPage;
            pageBtn.addEventListener('click', () => renderPage(i));
            controls.appendChild(pageBtn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Next';
        nextBtn.className = 'px-2 py-1 border rounded';
        nextBtn.disabled = pageNumber === totalPages;
        nextBtn.addEventListener('click', () => renderPage(currentPage + 1));
        controls.appendChild(nextBtn);
    }
    
    // --- FUNCIONES AUXILIARES DEL MODAL ---

    function manejarInputFila(row) {
        const clave = row.dataset.clave;
        const sistemaInput = row.querySelector('input[data-type="stockSistema"]');
        const fisicoInput = row.querySelector('input[data-type="stockFisico"]');
        const cpiInput = row.querySelector('input[data-type="cpi"]');
        const vpeInput = row.querySelector('input[data-type="vpe"]');
        const razonSelect = row.querySelector('select[data-type="razon"]');

        const valores = {
            clave: clave,
            descripcion: row.querySelector('.text-sm.font-medium').textContent,
            stockSistema: sistemaInput.value,
            stockFisico: fisicoInput.value,
            cpi: cpiInput.value,
            vpe: vpeInput.value,
            razon: razonSelect.value
        };

        const anyValue = valores.stockSistema !== '' || valores.stockFisico !== '' || valores.cpi !== '' || valores.vpe !== '' || valores.razon !== '';
        if (anyValue) {
            editedData[clave] = valores;
        } else {
            delete editedData[clave];
        }

        actualizarColorInputs(row);
        calcularYMostrarDiferencia(row);
    }

    function actualizarColorInputs(row) {
        row.querySelectorAll('input[data-type="stockFisico"], input[data-type="cpi"], input[data-type="vpe"], select[data-type="razon"]').forEach(el => {
            if (el.value && el.value !== '') {
                el.classList.add('text-gray-900');
                el.classList.remove('text-gray-500');
            } else {
                el.classList.add('text-gray-500');
                el.classList.remove('text-gray-900');
            }
        });
    }
    
    function calcularYMostrarDiferencia(row) {
        const sistema = parseFloat(row.querySelector('input[data-type="stockSistema"]').value) || 0;
        const fisico = parseFloat(row.querySelector('input[data-type="stockFisico"]').value) || 0;
        const cpi = parseFloat(row.querySelector('input[data-type="cpi"]').value) || 0;
        const vpe = parseFloat(row.querySelector('input[data-type="vpe"]').value) || 0;
        const diferencia = fisico - sistema - vpe - cpi;
        
        const diferenciaSpan = row.querySelector('.difference-value');
        diferenciaSpan.textContent = diferencia.toFixed(2);

        row.classList.remove('row-diff-positive', 'row-diff-negative');
        diferenciaSpan.classList.remove('diff-positive', 'diff-negative', 'diff-zero');

        if (diferencia > 0) {
            diferenciaSpan.classList.add('diff-positive');
            row.classList.add('row-diff-positive');
        } else if (diferencia < 0) {
            diferenciaSpan.classList.add('diff-negative');
            row.classList.add('row-diff-negative');
        } else {
            diferenciaSpan.classList.add('diff-zero');
        }
    }

    function registrarConteos() {
        const conteosValidos = Object.values(editedData).filter(d => d.stockFisico !== '');
        
        if (conteosValidos.length === 0) {
            mostrarConfirmacion({
                title: "Sin cambios para registrar",
                body: "Debes introducir el 'Stock Físico' para al menos un artículo antes de poder registrar.",
                primaryText: "Entendido",
                primaryClass: "bg-indigo-600 hover:bg-indigo-700",
                showSecondary: false
            });
            return;
        }

        const summaryList = conteosValidos.map(item => {
             const diferencia = (parseFloat(item.stockFisico) || 0) - (parseFloat(item.stockSistema) || 0) - (parseFloat(item.cpi) || 0) - (parseFloat(item.vpe) || 0);
             let colorClass = diferencia > 0 ? 'text-green-600' : (diferencia < 0 ? 'text-red-600' : 'text-gray-700');
             return `<li>${item.descripcion} (Diferencia: <strong class="${colorClass}">${diferencia.toFixed(2)}</strong>)</li>`;
        }).join('');

        mostrarConfirmacion({
            title: "Confirmar Registro de Conteos",
            body: `Se van a registrar ajustes para <strong>${conteosValidos.length} artículos</strong>. <ul class="list-disc list-inside mt-2">${summaryList}</ul><p class="mt-4">¿Deseas continuar?</p>`,
            primaryText: "Confirmar y Registrar",
            primaryClass: "bg-green-600 hover:bg-green-700",
            onPrimaryClick: () => {
                showSpinner(true);
                google.script.run
                    .withSuccessHandler(response => {
                        showSpinner(false);
                        editedData = {};
                        mostrarConfirmacion({
                            title: "Éxito", body: response, primaryText: "Aceptar", primaryClass: "bg-indigo-600 hover:bg-indigo-700",
                            onPrimaryClick: () => {
                                document.getElementById('confirmation-modal-container').classList.add('hidden');
                                cerrarModalDeConteo();
                            },
                            showSecondary: false
                        });
                    })
                    .withFailureHandler(err => {
                        showSpinner(false);
                        mostrarConfirmacion({title: "Error", body: err.message, primaryText: "Cerrar", primaryClass: "bg-red-600 hover:bg-red-700", showSecondary: false});
                    })
                    .registrarMultiplesConteos(conteosValidos, perfilActual.UsuarioID);
            }
        });
    }

    function cerrarModalDeConteo() {
        if (Object.keys(editedData).length > 0) {
            mostrarConfirmacion({
                title: "Advertencia: Cambios sin guardar",
                body: "Tienes conteos modificados que no se han registrado. Si cierras, perderás estos cambios.",
                primaryText: "Cerrar sin guardar",
                primaryClass: "bg-red-600 hover:bg-red-700",
                secondaryText: "Continuar editando",
                onPrimaryClick: () => {
                    forceCloseModal();
                }
            });
        } else {
            forceCloseModal();
        }
    }
    
    function forceCloseModal() {
        editedData = {};
        inventoryData = [];
        hasSearched = false;
        currentPage = 1;
        const modalOverlay = document.getElementById('modal-container'); // Re-seleccionar por si acaso
        if(modalOverlay) modalOverlay.classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('modal-container').innerHTML = ''; // Limpiar el contenido
    }

    function handleSearch(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = e.target.value.trim();
            if (query === '') return;
            hasSearched = true;
            currentFilter = 'todos'; // La búsqueda anula el filtro de 'hoy'
            actualizarBotonesFiltro();
            cargarYRenderizarInventario();
        }
    }

    function actualizarBotonesFiltro() {
        document.querySelectorAll('.inventory-filter-btn').forEach(btn => {
            const isSelected = btn.dataset.filter === currentFilter;
            btn.classList.toggle('bg-indigo-600', isSelected);
            btn.classList.toggle('text-white', isSelected);
            btn.classList.toggle('bg-gray-200', !isSelected);
            btn.classList.toggle('text-gray-700', !isSelected);
        });
    }

    // --- LÓGICA DE ACCIONES EN LOTE ---

    function toggleSelectAll() {
        const isChecked = document.getElementById('select-all-checkbox').checked;
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = isChecked);
        actualizarVisibilidadAccionesLote();
    }

    function actualizarVisibilidadAccionesLote() {
        const anySelected = document.querySelectorAll('.row-checkbox:checked').length > 0;
        document.getElementById('batch-action-container').classList.toggle('hidden', !anySelected);
    }
    
    function aplicarRazonEnLote() {
        const reason = document.getElementById('batch-reason-select').value;
        if (!reason) return;
        document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
            const row = cb.closest('tr');
            row.querySelector('select[data-type="razon"]').value = reason;
            manejarInputFila(row); // Asegura que el cambio se registre en editedData
        });
    }

    function imprimirTabla() {
        const printWindow = window.open('', '_blank');
        const rowsHtml = inventoryData.map(item => {
            const data = editedData[item.Clave] || {};
            const sistema = data.stockSistema !== undefined ? data.stockSistema : (item.StockSistema || 0);
            const fisico = data.stockFisico !== undefined ? data.stockFisico : '';
            const cpi = data.cpi !== undefined ? data.cpi : '';
            const vpe = data.vpe !== undefined ? data.vpe : '';
            const razon = data.razon !== undefined ? data.razon : '';
            return `<tr><td>${item.Clave}</td><td>${item.Descripcion || ''}</td><td>${sistema}</td><td>${fisico}</td><td>${cpi}</td><td>${vpe}</td><td>${razon}</td></tr>`;
        }).join('');

        printWindow.document.write(`<!DOCTYPE html><html><head><title>Conteo</title><style>table{border-collapse:collapse;width:100%;font-size:12px}th,td{border:1px solid #000;padding:4px;text-align:left;}th{background:#f0f0f0;}</style></head><body><table><thead><tr><th>Clave</th><th>Producto</th><th>Sistema</th><th>Físico</th><th>CPI</th><th>VPE</th><th>Razón</th></tr></thead><tbody>${rowsHtml}</tbody></table></body></html>`);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }

    // --- MODAL DE CONFIRMACIÓN GENÉRICO ---
    function mostrarConfirmacion(config) {
        const modal = document.getElementById('confirmation-modal-container');
        const titleEl = document.getElementById('confirmation-title');
        const bodyEl = document.getElementById('confirmation-body');
        const primaryBtn = document.getElementById('confirm-btn-primary');
        const secondaryBtn = document.getElementById('confirm-btn-secondary');

        titleEl.textContent = config.title;
        bodyEl.innerHTML = config.body;
        primaryBtn.textContent = config.primaryText;
        primaryBtn.className = `px-4 py-2 text-white rounded-md ${config.primaryClass}`;
        
        if(config.showSecondary === false) {
            secondaryBtn.classList.add('hidden');
        } else {
            secondaryBtn.classList.remove('hidden');
            secondaryBtn.textContent = config.secondaryText || 'Cancelar';
        }

        // Clonar y reemplazar para limpiar listeners previos
        const newPrimary = primaryBtn.cloneNode(true);
        primaryBtn.parentNode.replaceChild(newPrimary, primaryBtn);
        newPrimary.addEventListener('click', () => {
            if (config.onPrimaryClick) config.onPrimaryClick();
            else modal.classList.add('hidden');
        });

        const newSecondary = secondaryBtn.cloneNode(true);
        secondaryBtn.parentNode.replaceChild(newSecondary, secondaryBtn);
        newSecondary.addEventListener('click', () => {
             if (config.onSecondaryClick) config.onSecondaryClick();
             else modal.classList.add('hidden');
        });
        
        modal.classList.remove('hidden');
    }

    // --- SPINNERS ---
    function showSpinner(show) { /* Implementa tu spinner de carga global */ }
    function showTableSpinner(show) {
        const tableBody = document.getElementById('inventory-table-body');
        if (show) {
            tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-gray-500">Cargando datos...</td></tr>`;
        }
    }
    
    // Asigna el evento al botón principal que abre el modal
    if(openModalBtn) {
        openModalBtn.addEventListener('click', abrirModalDeConteo);
    }

});
// --- FIN DE LA LÓGICA DEL MODAL DE CONTEO ---

    /**
     * Función central para cargar/refrescar todos los datos del panel de admin.
     * Realiza el proceso de 2 pasos: primero carga mensajes, luego los de caja.
     */
    function refrescarPanelAdmin() {
        console.log("Iniciando refresco completo del panel de admin...");
        const panel = document.getElementById('admin-panel');
        if(panel) {
            // Mostramos un mensaje de carga mientras se ejecutan las llamadas
            document.getElementById('admin-items-container').innerHTML = `<p class="text-slate-400 text-center text-sm p-4">Cargando ítems...</p>`;
        }

        // PASO A: Cargar los mensajes
        google.script.run
            .withSuccessHandler(itemsIniciales => {
                console.log("Refresco - Mensajes recibidos:", itemsIniciales);
                
                // Guardamos los primeros datos
                const safeItemsIniciales = Array.isArray(itemsIniciales) ? itemsIniciales : [];
                let combinedItems = safeItemsIniciales.map(d => ({...d, fecha: d.fecha ? new Date(d.fecha) : null}));
                adminState.items = combinedItems;
                
                // Renderizamos la lista solo con mensajes para una carga rápida inicial
                renderFilteredAdminItems();

                // PASO B: Cargar los movimientos de caja
                google.script.run
                    .withSuccessHandler(itemsDeCaja => {
                        console.log("Refresco - Caja recibida:", itemsDeCaja);
                        const safeItemsDeCaja = Array.isArray(itemsDeCaja) ? itemsDeCaja : [];
                        const nuevosItems = safeItemsDeCaja.map(d => ({...d, fecha: d.fecha ? new Date(d.fecha) : null}));
                        
                        // Fusionamos los arrays
                        adminState.items = [...combinedItems, ...nuevosItems];
                        
                        // Re-ordenamos la lista combinada
                        adminState.items.sort((a, b) => {
                            const dateA = (a.fecha instanceof Date && !isNaN(a.fecha.getTime())) ? a.fecha.getTime() : 0;
                            const dateB = (b.fecha instanceof Date && !isNaN(b.fecha.getTime())) ? b.fecha.getTime() : 0;
                            return dateB - dateA; // De más reciente a más antiguo
                        });
                        
                        console.log("Refresco - Estado final fusionado:", adminState.items);
                        // Volvemos a dibujar la lista de ítems ya con todo fusionado y ordenado
                        renderFilteredAdminItems(); 
                    })
                    .withFailureHandler(err => console.error("Error en el Paso B (Caja):", err))
                    .obtenerMovimientosDeCaja(); 
            })
            .withFailureHandler(err => console.error("Error en el Paso A (Mensajes):", err))
            .obtenerPanelAdminData_SoloMensajes();
    }

// --- COPIA Y PEGA ESTA FUNCIÓN COMPLETA EN TU <script> ---

/**
 * Configura la lógica para los botones de navegación móvil (Chat/Panel).
 * Este es el método definitivo que manipula directamente las clases de Tailwind.
 */
    function setupMobileViewToggle() {
        const btnShowChat = document.getElementById('btn-show-chat');
        const btnShowPanel = document.getElementById('btn-show-panel');
        const chatColumn = document.getElementById('chat-column');
        const adminPanel = document.getElementById('admin-panel');

        if (!btnShowChat || !btnShowPanel || !chatColumn || !adminPanel) {
            console.error("Elementos de navegación móvil no encontrados. La vista móvil no funcionará.");
            return;
        }

        // --- Lógica para el botón de CHAT ---
        btnShowChat.addEventListener('click', () => {
            if (btnShowChat.classList.contains('active')) return;

            // Ocultar el panel de admin
            adminPanel.classList.add('hidden');
            adminPanel.classList.remove('flex');

            // Mostrar la columna del chat
            chatColumn.classList.remove('hidden');
            chatColumn.classList.add('flex');

            // Actualizar el estado visual de los botones
            btnShowChat.classList.add('active');
            btnShowPanel.classList.remove('active');
        });

        // --- Lógica para el botón de PANEL ---
        btnShowPanel.addEventListener('click', () => {
            if (btnShowPanel.classList.contains('active')) return;
            
            // Ocultar la columna del chat
            chatColumn.classList.add('hidden');
            chatColumn.classList.remove('flex');
            
            // Mostrar el panel de admin
            adminPanel.classList.remove('hidden');
            adminPanel.classList.add('flex');

            // Actualizar el estado visual de los botones
            btnShowPanel.classList.add('active');
            btnShowChat.classList.remove('active');
        });
    }

    // =================================================================
// ==== NUEVA FUNCIÓN PARA CONTROLAR LA VISTA (CHAT O PANEL) ====
// =================================================================
function updateActiveView(viewName) {
    // Ocultar todos los paneles primero
    chatColumn.classList.add('hidden');
    adminPanel.classList.add('hidden');

    // Resetear estilos de los botones del switcher
    showChatBtn.classList.remove('bg-blue-600', 'text-white');
    showChatBtn.classList.add('text-slate-300', 'hover:bg-slate-600');
    showAdminPanelBtn.classList.remove('bg-blue-600', 'text-white');
    showAdminPanelBtn.classList.add('text-slate-300', 'hover:bg-slate-600');

    // Mostrar el panel activo y actualizar el estilo del botón
    if (viewName === 'chat') {
        chatColumn.classList.remove('hidden');
        showChatBtn.classList.add('bg-blue-600', 'text-white');
        showChatBtn.classList.remove('text-slate-300', 'hover:bg-slate-600');
    } else if (viewName === 'admin') {
        adminPanel.classList.remove('hidden');
        showAdminPanelBtn.classList.add('bg-blue-600', 'text-white');
        showAdminPanelBtn.classList.remove('text-slate-300', 'hover:bg-slate-600');
        
        // Opcional: Refrescar el panel de admin cada vez que se muestra
        if (typeof refrescarPanelAdmin === 'function') {
            refrescarPanelAdmin();
        }
    }
}



</script>
</body>
</html>
